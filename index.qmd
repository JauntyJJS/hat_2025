--- 
title: Retrospective clinical data harmonisation Reporting Using R and Quarto
author: Jeremy Selva [`r fontawesome::fa(name = "linkedin", fill = "#0077ac")`](https://www.linkedin.com/in/jeremy-selva-085b9112a/){target="_blank"} <br> @JauntyJJS [`r fontawesome::fa(name = "github", fill = "#000000")`](https://github.com/JauntyJJS){target="_blank"} [`r fontawesome::fa(name = "fab fa-square-x-twitter", fill = "#000000")`](https://twitter.com/JauntyJJS){target="_blank"} [`r fontawesome::fa(name = "bluesky", fill = "#1084ff")`](https://bsky.app/profile/jauntyjjs.bsky.social){target="_blank"} [<svg aria-hidden="true" role="img" viewBox="0 0 512 512" style="height:1em;width:1em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:#5f53e7;overflow:visible;position:relative;"><path d="M433 179.1c0-97.2-63.7-125.7-63.7-125.7-62.5-28.7-228.6-28.4-290.5 0 0 0-63.7 28.5-63.7 125.7 0 115.7-6.6 259.4 105.6 289.1 40.5 10.7 75.3 13 103.3 11.4 50.8-2.8 79.3-18.1 79.3-18.1l-1.7-36.9s-36.3 11.4-77.1 10.1c-40.4-1.4-83-4.4-89.6-54a102.5 102.5 0 0 1 -.9-13.9c85.6 20.9 158.7 9.1 178.8 6.7 56.1-6.7 105-41.3 111.2-72.9 9.8-49.8 9-121.5 9-121.5zm-75.1 125.2h-46.6v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.3V197c0-58.5-64-56.6-64-6.9v114.2H90.2c0-122.1-5.2-147.9 18.4-175 25.9-28.9 79.8-30.8 103.8 6.1l11.6 19.5 11.6-19.5c24.1-37.1 78.1-34.8 103.8-6.1 23.7 27.3 18.4 53 18.4 175z"/></svg>](https://fosstodon.org/@JauntyJJS){target="_blank"} <br> [*https://jeremy-selva.netlify.app* `r fontawesome::fa(name = "link", fill = "#666666")`](https://jeremy-selva.netlify.app/){target="_blank"} <br> For [Harvest Analytics Together (HAT) 2025 `r fontawesome::fa(name = "link", fill = "#666666")`](https://www.eventbrite.sg/o/cgh-harvest-analytics-together-hat-90682070963){target="_blank"}
date: 2025-11-14
date-format: "D[<sup style='font-size:65%;font-style:italic;'>th</sup>] MMMM YYYY"
lightbox: true
from: markdown+emoji
format:
  revealjs:
    theme: [custom.scss]
    mainfont: "Newsreader"
    code-line-numbers: true
    code-annotations: false
    code-overflow: scroll
    controls: true
    progress: true
    #slide-number: true # slide number determined be no_logo_at_title_slide.js
    scrollable: true
    transition: fade
    background-transition: fade
    highlight-style: arrow-dark
    # logo: images/qr.png
    include-after-body: no_logo_at_title_slide.js
    include-in-header:
      text: |
        <meta name="github-repo" content="JauntyJJS/hat_2025 />
        <meta name="twitter:title" content="Retrospective clinical data harmonisation Reporting Using R and Quarto" />
        <meta name="twitter:description" content="Presentation for Harvest Analytics Together 2025." />
        <meta name="twitter:url" content="https://jauntyjjs.github.io/hat_2025/" />
        <meta name="twitter:image" content="https://raw.githubusercontent.com/JauntyJJS/hat_2025/main/share-card.png" />
        <meta name="twitter:image:alt" content="Title slide of Retrospective clinical data harmonisation Reporting Using R and Quarto presented at Harvest Analytics Together 2025." />
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:creator" content="@JauntyJJS" />
        <meta name="twitter:site" content="@JauntyJJS" />
        <meta property="og:title" content="Retrospective clinical data harmonisation Reporting Using R and Quarto" />
        <meta property="og:description" content="Presentation for Harvest Analytics Together 2025." />
        <meta property="og:url" content="https://jauntyjjs.github.io/hat_2025/" />
        <meta property="og:image" content="https://raw.githubusercontent.com/JauntyJJS/hat_2025/main/share-card.png" />
        <meta property="og:image:alt" content="Title slide of Retrospective clinical data harmonisation Reporting Using R and Quarto presented at Harvest Analytics Together 2025." />
        <meta property="og:site_name" content="Harvest Analytics Together 2025" />
        <meta property="og:type" content="website" />
        <meta property="og:locale" content="en_UK" />
        <meta property="article:author" content="Jeremy Selva" />
title-slide-attributes:
    data-background-image: "images/title.png"
    data-background-size: contain
    data-background-opacity: "1"

--- 

```{r}
#| label: for presentation
#| include: false

library(fontawesome)
library(knitr)
library(yaml)
library(rmarkdown)
library(here)

out_type <- knitr::opts_chunk$get("rmarkdown.pandoc.to")
```

```{r}
#| label: for harmonisation
#| include: false
#| echo: false

library(fs)
library(quarto)
library(dplyr)
library(magrittr)
library(stringr)
library(forcats)
library(purrr)
library(tibble)
library(here)
library(testthat)
library(readxl)
library(vroom)
library(pointblank)
library(reactable)

library(ggplot2)
library(ggVennDiagram)
library(ComplexUpset)
library(daff)

source("R/factor-reactable.R")
source("R/integer-check.R")
source("R/rounding.R")

```

## whoami

Research Officer from [National Heart Centre Singapore](https://www.nhcs.com.sg/){target="_blank"} who collects, cleans and harmonises clinical data.

![](images/allison_horst2.png){fig-alt="Picture by Allison Horst about a data analyst facing a dataset in the form of a monster." fig-align="center" width="65%"}

::: footer

[https://jauntyjjs.github.io/hat_2025
`r fontawesome::fa(name = "link", fill = "#666666")`](https://jauntyjjs.github.io/hat_2025){target="_blank"} [`r fontawesome::fa(name = "github", fill = "#000000")`](https://github.com/JauntyJJS/hat_2025){target="_blank"} [`r fontawesome::fa(name = "file-pdf", fill = "#b50b00")`](https://raw.githubusercontent.com/JauntyJJS/hat_2025/main/index.pdf){target="_blank"}

:::

[Taming the Data Beast from ["Cleaning Medical Data with R"](https://www.pipinghotdata.com/workshops/2023-06-06-cleaning-medical-data-with-r/){target="_blank"} workshop by Shannon Pileggi, Crystal Lewis and Peter Higgins presented at R/Medicine 2023. Illustrated by [Allison Horst](https://allisonhorst.com/){target="_blank"}]{style="font-size: 60%;"}.

## About Data Harmonisation

Data harmonisation is part of data wrangling process where

-  Similar variables from different datasets are identified.
-  Grouped based on a generalised concept they represent.
-  Transformed into unified harmonised variables for analysis.

![](images/data_harmonisation.png){fig-alt="The data harmonization process: Study data variables collected from different sources need to be mapped to one another, classified into the generalized concepts they represent, and transformed into unified harmonized variables for analysis" fig-align="center" width="90%"}

[Image from Mallya et al. Circ Cardiovasc Qual Outcomes. 2023 Nov; 16(11):e009938 doi: [10.1161/CIRCOUTCOMES.123.009938](https://doi.org/10.1161/CIRCOUTCOMES.123.009938){target="_blank"}]{style="font-size: 60%;"}.

## How it started

![](images/welcome.png){fig-alt="Figure showing me welcoming the collaborator to the project and sending them a data dictionary and template file for them to use and send the data back to me." fig-align="center" width="90%"}

[[Cheerful Businessman](https://www.vecteezy.com/png/57446607-a-cheerful-little-businessman-carrying-a-briefcase-walks-confidently-on-a-bright-day-in-a-fun-animated-style-little-business-man-illustrationisolated-on-transparent-background){target="_blank"} designed by [Iftikhar Alam](https://www.vecteezy.com/members/iftikharalam){target="_blank"} from [Vecteezy](http://www.vecteezy.com){target="_blank"} and [Medical Doctor Man](https://creazilla.com/media/clipart/33960/trevor-medical-doctor-man){target="_blank"} from [Creazilla](https://creazilla.com/){target="_blank"}]{style="font-size: 60%;"}.

## How it started

![](images/collaborator_issue.png){fig-alt="Figure showing the collaborator sharing that he does not have an analyst to do the mapping and warns that if his end were to do it himself, it will take a long time." fig-align="center" width="90%"}

[[Cheerful Businessman](https://www.vecteezy.com/png/57446607-a-cheerful-little-businessman-carrying-a-briefcase-walks-confidently-on-a-bright-day-in-a-fun-animated-style-little-business-man-illustrationisolated-on-transparent-background){target="_blank"} designed by [Iftikhar Alam](https://www.vecteezy.com/members/iftikharalam){target="_blank"} from [Vecteezy](http://www.vecteezy.com){target="_blank"} and [Medical Doctor Man](https://creazilla.com/media/clipart/33960/trevor-medical-doctor-man){target="_blank"} from [Creazilla](https://creazilla.com/){target="_blank"}]{style="font-size: 60%;"}.

## How it started

![](images/collaborator_request_1.png){fig-alt="Figure showing the collaborator saying that they will send the data to me and ask me to do the data harmonisation instead." fig-align="center" width="90%"}

[[Cheerful Businessman](https://www.vecteezy.com/png/57446607-a-cheerful-little-businessman-carrying-a-briefcase-walks-confidently-on-a-bright-day-in-a-fun-animated-style-little-business-man-illustrationisolated-on-transparent-background){target="_blank"} designed by [Iftikhar Alam](https://www.vecteezy.com/members/iftikharalam){target="_blank"} from [Vecteezy](http://www.vecteezy.com){target="_blank"} and [Medical Doctor Man](https://creazilla.com/media/clipart/33960/trevor-medical-doctor-man){target="_blank"} from [Creazilla](https://creazilla.com/){target="_blank"}]{style="font-size: 60%;"}.

## How it started

![](images/qa_image_monkeyuser.png){fig-alt="Figure showing a sad guy receving a package/data full of bugs and issue." fig-align="center" width="90%"}

[[snapshot from Ready for QA | MonkeyUser 2SP Animation Video](https://www.youtube.com/watch?v=5Z8HDADU57U&ab_channel=MonkeyUser){target="_blank"} from [MonkeyUser.com](https://www.monkeyuser.com/)]{style="font-size: 60%;"}.

## How it started

![](images/qa_image_monkeyuser_9_times.png){fig-alt="A 3 by 3 repeared figure showing a sad guy receving a package/data full of bugs and issue." fig-align="center" width="90%"}

[[snapshot from Ready for QA | MonkeyUser 2SP Animation Video](https://www.youtube.com/watch?v=5Z8HDADU57U&ab_channel=MonkeyUser){target="_blank"} from [MonkeyUser.com](https://www.monkeyuser.com/)]{style="font-size: 60%;"}.

## How it started

Turn my sorrow into opportunities.

```{=html}
<iframe width="970" height="550" src="https://jauntyjjs.github.io/useR-2024/#/title-slide" frameborder="0" allowfullscreen></iframe>
```

## Why a harmonisation report

![](images/collaborator_request_2.png){fig-alt="Figure showing the collaborator saying that they need the harmonised dataset back with a report for higher management to show to data auditors." fig-align="center" width="90%"}

[[Cheerful Businessman](https://www.vecteezy.com/png/57446607-a-cheerful-little-businessman-carrying-a-briefcase-walks-confidently-on-a-bright-day-in-a-fun-animated-style-little-business-man-illustrationisolated-on-transparent-background){target="_blank"} designed by [Iftikhar Alam](https://www.vecteezy.com/members/iftikharalam){target="_blank"} from [Vecteezy](http://www.vecteezy.com){target="_blank"} and [Medical Doctor Man](https://creazilla.com/media/clipart/33960/trevor-medical-doctor-man){target="_blank"} from [Creazilla](https://creazilla.com/){target="_blank"}]{style="font-size: 60%;"}.

## Why a harmonisation report

Some data fields just cannot be planned in advanced.

![](images/ethnicity_table.png){fig-alt="Figure showing different race or ethnicity grouping from different collaborators that it is impossible to plan race or ethnicity grouping." fig-align="center" width="90%"}

## Issues

:::: {.columns}

::: {.column width="50%"}

While there are {{< fa brands r-project >}} üì¶ to facilitate data harmonisation,

*  [`retroharmonize`](https://github.com/rOpenGov/retroharmonize/){target="_blank"} for survey data.

*  [`Rmonize`](https://maelstrom-research.github.io/Rmonize-documentation/index.html){target="_blank"} for epidemiological data.

*  [`psHarmonize`](https://github.com/NUDACC/psHarmonize){target="_blank"} for health and education data.

There are limited resources on how to make a data harmonisation report.

:::

::: {.column width="50%"}

![](images/210-denvercoder9.png){fig-alt="Comic from Monkeyuser.com showing that it is hard to get help with programming issues." fig-align="center" width="100%"}

[[Denvercoder9](https://www.monkeyuser.com/2021/denvercoder9/){target="_blank"} from [MonkeyUser.com](https://www.monkeyuser.com/){target="_blank"}]{style="font-size: 60%;"}

:::

::::

## Harmonisation Project Template

A template to offer a systematic way to report data harmonisation processes. 

[Link: <https://jauntyjjs.github.io/harmonisation/>]

```{=html}
<iframe width="1000" height="500" src="https://jauntyjjs.github.io/harmonisation/" title="Harmonisation template" ></iframe>
```


## Tools to create documentation

![](images/r_and_quarto.png){fig-alt="Figure showing the logo of the R programming language and hexsticker of Quarto." fig-align="center" width="80%"}

[[R Programming Logo](https://www.cleanpng.com/png-scalable-vector-graphics-cran-statgraphics-rnn-vit-6890332/download-png.html){target="_blank"} from [CleanPNG](https://www.cleanpng.com/){target="_blank"} and [Quarto Hex Sticker](https://rstudio.github.io/cheatsheets/html/quarto.html){target="_blank"} from [Posit](https://posit.co/){target="_blank"}]{style="font-size: 60%;"}.

## 

<br>

::: {.center-x .r-fit-text}
What [*Did*]{.important} We Forget <br> to Teach You about {{< fa brands r-project >}} ?
:::

![](images/what_is_R_programming.png){fig-alt="Figure showing a Google search on what is the R Programming Language." fig-align="center" width="60%"}

##

![](images/everything-else.png){fig-alt="Figure showing that R is taught only as a tool to do statistics but not other stuffs." fig-align="center" width="80%"}

[Image from [Project Oriented Workflows slides](https://rstats-wtf.github.io/wtf-project-oriented-workflow-slides/#/title-slide){target="_blank"} from [What They Forgot to Teach You About R](http://rstats.wtf)]{style="font-size: 60%;"}.

<br>

We will share a glimpse of "Everything else" R and its friends can do.

## Pipes

{{< fa brands r-project >}} $\geq$ 4.1.0 has a "pipe" symbol `|>` to make code easier to read.

Without `|>`

```{r}
#| label: no pipe function example 1
#| echo: true
#| eval: false
#| output: false

data_after_task_3 <- task_3(task_2(task_1(data, arg_1_2), arg_2_2, arg_2_3), arg_3_2, arg_3_3)

```

```{r}
#| label: no pipe function example 2
#| echo: true
#| eval: false
#| output: false

data_after_task_1 <- task_1(data, arg_1_2)

data_after_task_2 <- task_2(data_after_task_1, arg_2_2, arg_2_3)

data_after_task_3 <- task_3(data_after_task_2, arg_3_2, arg_3_3)

```

With `|>`

```{r}
#| label: pipe function example
#| echo: true
#| eval: false
#| output: false

data_after_task_3 <- data |> 
  task_1(arg_1_2) |> 
  task_2(arg_2_2, arg_2_3) |>
  task_3(arg_3_2, arg_3_3)

```

<br>

Inspired from the Bash Pipe `|`

``` {.bash filename="terminal" code-line-numbers="false"}
# List files, then filter by row, then filter by column, then sort.
ls -l | grep drw | awk '{print $9}' | sort
```

## Pipes

-   2014+ {{< fa brands r-project >}} üì¶ [magrittr](https://magrittr.tidyverse.org/){target="_blank"} pipe [`%>%`](https://magrittr.tidyverse.org/reference/pipe.html){target="_blank"}

-   2021+ ({{< fa brands r-project >}} $\geq$ 4.1.0) native {{< fa brands r-project >}} pipe `|>`

{{< fa blog >}} More details between the two pipes in [Understanding the native R pipe \|\>](https://ivelasq.rbind.io/blog/understanding-the-r-pipe/){target="_blank"}.

<iframe width="1000" height="400" src="https://ivelasq.rbind.io/blog/understanding-the-r-pipe/" title="Understanding the native R pipe" ></iframe>

## Namespacing

[`dplyr::select()`](https://dplyr.tidyverse.org/reference/select.html){target="_blank"}

-   tells R explicitly to use the function `select` from the package `dplyr`

-   can help to avoid name conflicts (e.g., `MASS::select()`)

-   does not require `library(dplyr)`

:::: {.columns}

::: {.column width="50%"}

:::{.center-h}
[**Without Namespace**]{style="font-size: 80%;"}
:::

```{r}
#| label: dplyr without namespace
#| echo: true
#| eval: false
#| output: false

library(dplyr)

select(mtcars, mpg, cyl) 

mtcars |>  
  select(mpg, cyl) 
```

:::

::: {.column width="50%"}

:::{.center-h}
[**With Namespace**]{style="font-size: 80%;"}
:::

```{r}
#| label: dplyr with namespace
#| echo: true
#| eval: false
#| output: false

# library(dplyr) not needed

dplyr::select(mtcars, mpg, cyl) 

mtcars |>  
  dplyr::select(mpg, cyl) 
```

:::

::::

::: aside
Adapted from [Iterating well with purrr](https://rstats-wtf.github.io/wtf-purrr-slides/){target="_blank"}
:::

## {{< fa brands r-project >}} Session

Before {{< fa brands r-project >}} starts up in a given project, it will perform the following steps

1. Set up Environment Variables.
2. Run startup script.
3. Set up the {{< fa brands r-project >}} session.

We can customise Step 1 and 2 using these two main text files.

-  `.Renviron` (Contains environment variables to be set in {{< fa brands r-project >}} sessions.)
-  `.Rprofile` (Contains {{< fa brands r-project >}} code to be run in each session.)

![](images/start_up_enviromental_files.png){fig-alt="Figure showing the .Renviron and .Rprofile file in an R project template." fig-align="center" width="60%"}

## what goes in `.Renviron`

:white_check_mark: {{< fa brands r-project >}}-specific [environment variables](https://cran.r-project.org/doc/manuals/r-devel/R-ints.html){target="_blank"}.\
:white_check_mark: API keys or other secrets\
:x: R code

``` bash
APPDATA="D:/Jeremy/PortableR/RAppData/Roaming"
LOCALAPPDATA="D:/Jeremy/PortableR/RAppData/Local"
TEMP="D:/Jeremy/PortableR/RPortableWorkDirectory/temp"
TMP="D:/Jeremy/PortableR/RPortableWorkDirectory/temp"
_R_CHECK_SYSTEM_CLOCK_=0
RENV_CONFIG_PAK_ENABLED=TRUE
CONNECT_API_KEY=DaYK2hBUriSBYUEGIAiyXsRJHSjTYJN3
DB_USER=elephant
DB_PASS=p0stgr3s
```
:::: {.columns}

::: {.column width="40%"}

### user

`~/.Renviron`

:::

::: {.column width="60%"}

### project

`path/to/your/project/.Renviron`

:::

::::

::: aside
Adapted from [Personal R Administration](https://rstats-wtf.github.io/wtf-personal-radmin-slides/#/how-do-i-know-i-got-a-binary){target="_blank"}
:::

## what goes in `.Rprofile`

:white_check_mark: set a default CRAN mirror.\
:white_check_mark: customize [R prompt](https://github.com/gaborcsardi/prompt/){target="_blank"}.\

```r
source("renv/activate.R")
options(
  repos = c(
    P3M_20250306 = "https://packagemanager.posit.co/cran/2025-10-13",
    ropensci = "https://ropensci.r-universe.dev",
    janmarvin = "https://janmarvin.r-universe.dev",
    CRAN = 'https://cloud.r-project.org'
  )
)
if (interactive()) prompt::set_prompt(prompt::prompt_fancy)
```

Examples: <https://github.com/search?q=.Rprofile&type=repositories>{target="_blank"}

{{< fa brands github >}} [csgillespie/rprofile](https://github.com/csgillespie/rprofile){target="_blank"}.\
{{< fa brands youtube >}} [Me, Myself and my Rprofile](https://www.youtube.com/watch?v=2rWi2KVcyjg){target="_blank"}.\
{{< fa blog >}} [Customising your Rprofile](https://www.jumpingrivers.com/blog/customising-your-rprofile/){target="_blank"}.

::: aside
Adapted from [Personal R Administration](https://rstats-wtf.github.io/wtf-personal-radmin-slides/#/how-do-i-know-i-got-a-binary){target="_blank"}
:::

## States of {{< fa brands r-project >}} üì¶

{{< fa brands r-project >}} üì¶ -- [Structure](https://r-pkgs.org/Structure.html){target="_blank"}

![](images/r_package_structure.png){fig-alt="Figure showing the summary of the phases of the R package structure." fig-align="center" width="100%"}

::: aside
Adapted from [Personal R Administration](https://rstats-wtf.github.io/wtf-personal-radmin-slides/#/how-do-i-know-i-got-a-binary){target="_blank"}
:::

## Binary {{< fa brands r-project >}} üì¶ Installation

Go for ({{< fa brands windows >}} | {{< fa brands apple >}}) binary {{< fa brands r-project >}} üì¶ in CRAN.

-   compiled ahead of time -> easiest / fastest to install

![](images/binary_in_cran.png){fig-alt="Figure showing the Windows and Mac binary files of R package pretestcad." fig-align="center" width="70%"}

## R-universe and Posit Public Package Manager

:::: {.columns}

::: {.column width="40%"}

Consider installing ({{< fa brands windows >}} | {{< fa brands apple >}} | {{< fa brands linux >}} ) binaries from 

-  [R-universe](https://r-universe.dev/search){target="_blank"} 
-  [Posit Public Package Manager](https://p3m.dev/client/#/){target="_blank"}.

Set in your `.Rprofile` file.

```{.r code-line-numbers="3-4"}
options(
  repos = c(
    P3M_20250306 = "https://packagemanager.posit.co/cran/2025-10-13",
    ropensci = "https://ropensci.r-universe.dev",
    CRAN = 'https://cloud.r-project.org'
  )
)
```

:::

::: {.column width="60%"}

![](images/appsilon_R_universe.png){fig-alt="Website of Appsilon R-universe." fig-align="center" width="90%"}

![](images/posit_public_package_manager.png){fig-alt="Website of Posit Public Package Manager." fig-align="center" width="90%"}

:::

::::

## How do I know I got a binary?

::: panel-tabset

### CRAN {{< fa brands windows >}}

``` {.r code-line-numbers="4,10"}
> install.packages("parallelly", repos = "https://cran.r-project.org")
Installing package into ‚ÄòC:/Users/edavi/Documents/R/win-library/4.1‚Äô
(as ‚Äòlib‚Äô is unspecified)
trying URL 'https://cran.r-project.org/bin/windows/contrib/4.1/parallelly_1.32.1.zip'
Content type 'application/zip' length 306137 bytes (298 KB)
downloaded 298 KB

package ‚Äòparallelly‚Äô successfully unpacked and MD5 sums checked

The downloaded binary packages are in
    C:\Users\edavi\AppData\Local\Temp\Rtmpa2s3e8\downloaded_packages
```

### CRAN {{< fa brands apple >}}

``` {.r code-line-numbers="4,10"}
> install.packages("renv", repos="https://cran.r-project.org")
Installing package into ‚Äò/Users/edavidaja/Library/R/x86_64/4.1/library‚Äô
(as ‚Äòlib‚Äô is unspecified)
trying URL 'https://cran.r-project.org/bin/macosx/contrib/4.1/renv_0.15.5.tgz'
Content type 'application/x-gzip' length 1866760 bytes (1.8 MB)
==================================================
downloaded 1.8 MB


The downloaded binary packages are in
 /var/folders/b5/fl4ff68d23s148tg1_1gnflc0000gn/T//RtmpMk69B0/downloaded_packages
```

### p3m

``` {.r code-line-numbers="4,10"}
> install.packages("remotes")
Installing package into ‚ÄòC:/Users/WDAGUtilityAccount/AppData/Local/R/win-library/4.2‚Äô
(as ‚Äòlib‚Äô is unspecified)
trying URL 'https://p3m.dev/cran/latest/bin/windows/contrib/4.2/remotes_2.4.2.zip'
Content type 'binary/octet-stream' length 399930 bytes (390 KB)
downloaded 390 KB

package ‚Äòremotes‚Äô successfully unpacked and MD5 sums checked

The downloaded binary packages are in
  C:\Users\WDAGUtilityAccount\AppData\Local\Temp\RtmpA1edRi\downloaded_packages
```

:::

::: aside
Adapted from [Personal R Administration](https://rstats-wtf.github.io/wtf-personal-radmin-slides/#/how-do-i-know-i-got-a-binary){target="_blank"}
:::

## Source {{< fa brands r-project >}} üì¶ Installation

Go for source {{< fa brands r-project >}} üì¶ if you need the latest version urgently.

![](images/binary_not_latest.png){fig-alt="Figure showing the Windows binary files are not the latest version for R package parallelly." fig-align="center" width="70%"}

 {{< fa brands linux >}} only have source {{< fa brands r-project >}} üì¶ in CRAN.

## Source {{< fa brands r-project >}} üì¶ Installation

You will need additional tools and dependencies. 

::: panel-tabset

### windows {{< fa brands windows >}}

Install [Rtools](https://cran.r-project.org/bin/windows/Rtools/){target="_blank"}

### macOS {{< fa brands apple >}}

Install [XCode](https://apps.apple.com/us/app/xcode/id497799835?mt=12){target="_blank"} :warning: take some time to install

``` {.bash filename="terminal" code-line-numbers="false"}
xcode-select --install
```

### linux {{< fa brands linux >}}

install tools via package manager, e.g.

````{.bash filename="terminal" code-line-numbers="false"}
apt install make
````

:::

<br>

Run `devtools::has_devel()` in console.

> `## Your system is ready to build packages!`

::: aside
Adapted from [Personal R Administration](https://rstats-wtf.github.io/wtf-personal-radmin-slides/#/how-do-i-know-i-got-a-binary){target="_blank"}
:::

## Install using {{< fa brands r-project >}} üì¶ [`pak`](https://pak.r-lib.org/index.html){target="_blank"}

Consider using [`pak::pkg_install`](https://pak.r-lib.org/reference/pkg_install.html){target="_blank"} instead of `install.packages()`

```{=html}
<iframe width="1000" height="500" src="https://r-in-production.org/packages.html" title="R in Production Chapter 6 Package installation" ></iframe>
```

## Isolated project environment using [`renv`](https://rstudio.github.io/renv/index.html){target="_blank"}

Most commonly used {{< fa brands r-project >}} üì¶ to create isolated project environments.

-  {{< fa brands youtube >}} [You should be using renv](https://www.youtube.com/watch?v=GwVx_pf2uz4){target="_blank"}.\
-  {{< fa file-powerpoint >}} [Making your R project future-proof with renv](https://ecohealthalliance.github.io/targets-renv-example/outputs/renv-presentation){target="_blank"}.\

```{=html}
<iframe width="1000" height="400" src="https://rstudio.github.io/renv/articles/lockfile.html" title="Anatomy of a Lockfile" ></iframe>
```

## {{< fa brands r-project >}} "virtual environment" using [`renv`](https://rstudio.github.io/renv/index.html){target="_blank"}

Some advice ...

-  Set `RENV_CONFIG_PAK_ENABLED=TRUE` in the `.Renviron` file for `renv::install()` uses `pak` at the backend to install {{< fa brands r-project >}} üì¶.
-  In an existing project, use `renv::init(bare = TRUE)` to initiate renv with an empty {{< fa brands r-project >}} library and then install {{< fa brands r-project >}} üì¶ manaully.
-  Indicate folders/files in the `.renvignore` file to ignore to speed up the snapshot process (`renv::snapshot`)
-  You can update the repositories specified in the `renv.lock` file.
   -  {{< fa blog >}} [Shannon Pileggi's blog on `renv::restore()`](https://www.pipinghotdata.com/posts/2024-09-16-ease-renvrestore-by-updating-your-repositories-to-p3m/){target="_blank"}.

## New Kid for {{< fa brands r-project >}} üì¶ managment [`Require`](https://require.predictiveecology.org/){target="_blank"}

```{=html}
<iframe width="1000" height="500" src="https://require.predictiveecology.org/" title="Homepage of R pacakage Require" ></iframe>
```

## Personal R Administration

{{< fa file-powerpoint >}} <https://rstats-wtf.github.io/wtf-personal-radmin-slides>{target="_blank"}

<iframe width="1000" height="500" src="https://rstats-wtf.github.io/wtf-personal-radmin-slides" title="R Personal Administration" ></iframe>

## Project Organisation

[*Organise*]{.important} your project as you go instead of waiting for "tomorrow". 

Data is cheap but time is expensive.

:::: {.columns}

::: {.column width="50%"}

![](images/research_compendium.svg){fig-alt="Figure showing Research Compendium as a tool to sort out different analysis." fig-align="center" width="80%"}

:::

::: {.column width="50%"}

![](images/project_layout.png){fig-alt="Comic from Monkeyuser.com showing that it is hard to get help with programming issues." fig-align="center" width="80%"}

:::

::::

[[Research Compendium](https://book.the-turing-way.org/reproducible-research/compendia/){target="_blank"} by Scriberia from [The Turing Way project](https://book.the-turing-way.org/){target="_blank"} and Project Layout from [Good enough practices in scientific computing](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1005510){target="_blank"}]{style="font-size: 60%;"}.

## Project Organisation

My harmoniation template organisation is based on the {{< fa brands r-project >}} üì¶ [`rcompendium`](https://frbcesab.github.io/rcompendium){target="_blank"} but there are others ([`orderly`](https://github.com/mrc-ide/orderly){target="_blank"}, [`prodigenr`](https://rostools.github.io/prodigenr){target="_blank"} and [`workflowr`](https://workflowr.github.io/workflowr/){target="_blank"}) as well.

:::: {.columns}

::: {.column width="70%"}

<iframe width="750" height="500" src="https://frbcesab.github.io/rcompendium/" title="R Package rcompendium homepage" ></iframe>

:::

::: {.column width="30%"}

![](images/project_organisation_packages_2.png){fig-alt="Examples of R packages (rcompendium, orderly and workflowr) for project organisation." fig-align="center" width="100%"}

:::

::::

## If the top of your {{< fa brands r-project >}} script is

```{r}
#| label: top of the script
#| echo: true
#| eval: false
#| output: false

setwd("C:\Users\jenny\path\that\only\I\have")
rm(list = ls())

```

Jenny will come into your your office and SET YOUR COMPUTER ON FIRE üî•.

{{< fa blog >}} <https://tidyverse.org/blog/2017/12/workflow-vs-script/>{target="_blank"}

<iframe width="1000" height="400" src="https://tidyverse.org/blog/2017/12/workflow-vs-script/" title="Tidyverse Blog on Project-oriented workflow" ></iframe>

## Practise ‚Äúsafe paths‚Äù

{{< fa brands r-project >}} üì¶ with file system functions ([`fs`](https://fs.r-lib.org/){target="_blank"} and [`here`](https://here.r-lib.org/index.html){target="_blank"}).

:::: {.columns}

::: {.column width="50%"}

<iframe width="500" height="500" src="https://fs.r-lib.org/" title="R package fs homepage" ></iframe>

:::

::: {.column width="50%"}

<iframe width="500" height="500" src="https://here.r-lib.org/index.html" title="R package here homepage" ></iframe>

:::

::::

## Practise ‚Äúsafe paths‚Äù

:x:Avoid typing absolute path in {{< fa brands r-project >}} script. Let {{< fa brands r-project >}} do it for you.\

```{r}
#| echo: true
#| eval: false

BAD <- "D://Jeremy//PortableR//RPortableWorkDirectory//"
```

<br>

User's home directory

```{r}
#| label: home directory
#| echo: true

fs::path_home()
```

{{< fa brands r-project >}} Project directory

```{r}
#| label: project directory
#| echo: true

here::here()
```

<br>

[`here::here()`](https://here.r-lib.org/reference/here.html){target="_blank"} does not create directories; that‚Äôs your job.

## Practise ‚Äúsafe paths‚Äù

:x:Avoid typing `/` or `\` manually. Let {{< fa brands r-project >}} do it for you.\

```{r}
#| label: alternative to / or \
#| echo: true

file.path("data", "raw-data.csv")
fs::path_home("data", "raw-data.csv")
here::here("data", "raw-data.csv")

```

<br>

:white_check_mark: Use relative path within the {{< fa brands r-project >}} project\ directory.

```{r}
#| label: application of here
#| echo: true
#| eval: false

readxl::read_excel(path = here::here("data-folder", "data.xlsx"))
ggplot2::ggsave(filename = here::here("figs", "built-barchart.png"))
```

Works on my machine, works on yours!

## Practise ‚Äúsafe paths‚Äù

{{< fa brands youtube >}} [Efficient File Management in R with {fs} with Jadey Ryan](https://www.youtube.com/watch?v=X4i-yOBtn1s){target="_blank"}

<iframe width="1000" height="500" src="https://www.youtube.com/embed/X4i-yOBtn1s?si=wvCCKGqp-vXig_Lb" title="Efficient File Management in R with fs with Jadey Ryan" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

## Start {{< fa brands r-project >}} Session in a "blank slate"

:::: {.columns}

::: {.column width="50%"}

:x: Avoid `rm(list = ls())`\

![](images/persisted_options.png){fig-alt="Figure showing the options that persisted despite using rm(list = ls())." fig-align="center" width="100%"}
[Slide from [Project oriented workflows](https://rstats-wtf.github.io/wtf-project-oriented-workflow-slides){target="_blank"}]{style="font-size: 80%;"}.

<br>

:white_check_mark: Use [`usethis::use_blank_slate()`](https://usethis.r-lib.org/reference/use_blank_slate.html){target="_blank"}\

````{.r filename="R console" code-line-numbers="false"}
usethis::use_blank_slate()
````

:::

::: {.column width="50%"}

:white_check_mark: Tools -\> Global Options in RStudio.\

![](images/blank_slate.png){fig-alt="Starting R Session in a blank slate." fig-align="center" width="100%"}

:::

::::

## Project Oriented Workflow

{{< fa file-powerpoint >}} <https://rstats-wtf.github.io/wtf-project-oriented-workflow-slides>{target="_blank"}

<iframe width="1000" height="500" src="https://rstats-wtf.github.io/wtf-project-oriented-workflow-slides" title="Project Oriented Workflow" ></iframe>

## Quarto

[Quarto](https://quarto.org/){target="_blank"} is an open-source software that weaves narrative and programming code together to produce elegantly formatted output as documents (in HTML, Word, PDF), presentations, books, web pages, and more.

![](images/quarto_allison.png){fig-alt="Picture by Allison Horst about Quarto turning programming code to documents." fig-align="center"}
[[Artwork](https://allisonhorst.com/cetinkaya-rundel-lowndes-quarto-keynote){target="_blank"} from ["Hello, Quarto"](https://www.youtube.com/watch?v=p7Hxu4coDl8){target="_blank"} keynote by Julia Lowndes and Mine √áetinkaya-Rundel, presented at RStudio Conference 2022. Illustrated by [Allison Horst](https://allisonhorst.com/){target="_blank"}]{style="font-size: 80%;"}.

## Open A Quarto Document

Create a Quarto document

![](images/create_a_quarto_doc_grouped.png){fig-alt="Steps to create a Quarto document" fig-align="center"}

## Render to HTML Report

![](images/quarto_render.png){fig-alt="Steps to render a Quarto document to a report in html" fig-align="center"}

## Quarto Level 1

A Quarto file is a plain text file that has the extension `.qmd` containing three important types of content:

![](images/quarto_format.png){fig-alt="Quarto file has three contents: An optional YAML header surrounded by `---`s, Chunks of R code surrounded by ```s and Text mixed with markdown text formatting." fig-align="center"}
[Simple Quarto file example from [R for Data Science (2e) Chapter 28 Quarto](https://r4ds.hadley.nz/quarto.html#quarto-basics)]{style="font-size: 80%;"}

## Quarto Level 1

{{< fa blog >}} <https://kpuka.ca/resources/quarto_intro.html>{target="_blank"}

```{=html}
<iframe width="1000" height="550" src="https://kpuka.ca/resources/quarto_intro.html" title="Introduction to Quarto by Klajdi Puka, PhD" ></iframe>
```

## Quarto Level 2

````{.bash filename="terminal" code-line-numbers="false"}
quarto pandoc -o custom-reference-doc.docx --print-default-data-file reference.docx
````

{{< fa brands youtube >}}[How to change document fonts & formats in Quarto (Word/Docx)](https://www.youtube.com/watch?v=8CQiVVgQoH0){target="_blank"}

<iframe width="1000" height="450" src="https://www.youtube.com/embed/8CQiVVgQoH0?si=ByW6sp-mrfCKtzbf" title="How to change document fonts & formats in Quarto" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

## Quarto Level 2

{{< fa blog >}} [My word template for Quarto](https://andrewpwheeler.com/2024/06/21/my-word-template-for-quarto){target="_blank"}

<iframe width="1000" height="550" src="https://andrewpwheeler.com/2024/06/21/my-word-template-for-quarto" title="Word templates from Andrew Wheeler" ></iframe>

## Quarto Level 2

````{.bash filename="terminal" code-line-numbers="false"}
quarto install tinytex
````

{{< fa brands youtube >}}[Preparing RStudio to Generate PDF Files with Quarto and tinyTeX](https://www.youtube.com/watch?v=OUWOx80eJqk){target="_blank"}

<iframe width="1000" height="450" src="https://www.youtube.com/embed/OUWOx80eJqk?si=ptMrkq1pZWI9EqVn" title="Preparing RStudio to Generate PDF Files with Quarto and tinyTeX" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

## Quarto Level 2

{{< fa blog >}} [Christopher Kenny's Quarto templates](https://christophertkenny.com/quarto.html){target="_blank"}

<iframe width="1000" height="550" src="https://christophertkenny.com/quarto.html" title="Quarto pdf templates from Christopher Kenny" ></iframe>

## Workflow with collaborators

Collaborator can send the raw data once and you keep updating the cleaned data for harmonsation.

![](images/collaborator_no_change_raw_data_workflow.png){fig-alt="Picture showing a top workfow to first clean data for harmonisation before doing the actual harmonisation. Bottom workflow to verfiy with the collaborators and update the clean data for harmonisation periodically" fig-align="center" width="80%"}

[[Dataset vectors](https://www.vecteezy.com/vector-art/25844300-abstract-database-info-silhouette-illustration){target="_blank"} by [Vectora Artworks](https://www.vecteezy.com/members/vectoroartworks){target="_blank"} from [Vecteezy](https://www.vecteezy.com/){target="_blank"}.]{style="font-size: 60%;"}

## Workflow with collaborators

![](images/collaborator_request_3.png){fig-alt="Figure showing the collaborator saying that they need the updated raw data in addition to the harmonised data." fig-align="center" width="90%"}

[[Cheerful Businessman](https://www.vecteezy.com/png/57446607-a-cheerful-little-businessman-carrying-a-briefcase-walks-confidently-on-a-bright-day-in-a-fun-animated-style-little-business-man-illustrationisolated-on-transparent-background){target="_blank"} designed by [Iftikhar Alam](https://www.vecteezy.com/members/iftikharalam){target="_blank"} from [Vecteezy](http://www.vecteezy.com){target="_blank"} and [Medical Doctor Man](https://creazilla.com/media/clipart/33960/trevor-medical-doctor-man){target="_blank"} from [Creazilla](https://creazilla.com/){target="_blank"}]{style="font-size: 60%;"}.

## Workflow with collaborators

![](images/collaborator_request_3_met.png){fig-alt="Figure showing the data analyst providing the updated raw data and harmonised data." fig-align="center" width="90%"}

[[Cheerful Businessman](https://www.vecteezy.com/png/57446607-a-cheerful-little-businessman-carrying-a-briefcase-walks-confidently-on-a-bright-day-in-a-fun-animated-style-little-business-man-illustrationisolated-on-transparent-background){target="_blank"} designed by [Iftikhar Alam](https://www.vecteezy.com/members/iftikharalam){target="_blank"} from [Vecteezy](http://www.vecteezy.com){target="_blank"} and [Medical Doctor Man](https://creazilla.com/media/clipart/33960/trevor-medical-doctor-man){target="_blank"} from [Creazilla](https://creazilla.com/){target="_blank"}]{style="font-size: 60%;"}.

## Workflow with collaborators

Collaborator can update the raw data. For example, adding new clinical data, add more patients, correct errors.

![](images/collaborator_change_raw_data_workflow.png){fig-alt="Picture showing a top workfow to first clean data for harmonisation before doing the actual harmonisation. Bottom workflow to verfiy with the collaborators and update the raw data for harmonisation periodically" fig-align="center" width="80%"}

[[Dataset vectors](https://www.vecteezy.com/vector-art/25844300-abstract-database-info-silhouette-illustration){target="_blank"} by [Vectora Artworks](https://www.vecteezy.com/members/vectoroartworks){target="_blank"} from [Vecteezy](https://www.vecteezy.com/){target="_blank"}.]{style="font-size: 60%;"}

## Workflow with collaborators

New version means new bugs or reopen issues to fix. Is there an automated way to catch warnings/issues when reading these updated files ?

![](images/collaborator_change_raw_data_issue.png){fig-alt="Picture showing that new version of raw data sent by collaborator can give new issues to a supposedly fixed problem" fig-align="center" width="80%"}

[[Dataset vectors](https://www.vecteezy.com/vector-art/25844300-abstract-database-info-silhouette-illustration){target="_blank"} by [Vectora Artworks](https://www.vecteezy.com/members/vectoroartworks){target="_blank"} from [Vecteezy](https://www.vecteezy.com/){target="_blank"}. [Anticipate](https://www.monkeyuser.com/2022/anticipate/){target="_blank"} from [MonkeyUser.com](https://www.monkeyuser.com/){target="_blank"}]{style="font-size: 60%;"}

## Automated capture of warnings (csv)

Is there an automated way to catch warnings/issues when reading csv files ?

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: read data with warnings csv failed
#| echo: true
#| code-line-numbers: "|9"
#| warning: true

cohort_data_csv <- vroom::vroom(
  file = here::here("data-raw", "Cohort_csv", 
    "data_to_harmonise_age_issue.csv"),
  delim = ",",
  col_select = 1:2,
  show_col_types = FALSE,
  col_types = list(
    ID = vroom::col_character(), 
    Age = vroom::col_integer()
  )
)

```

```{r}
#| label: read data with warnings csv
#| echo: true
#| code-line-numbers: "|8"
#| warning: true

head(cohort_data_csv, n = 3)

```

:::

::: {.column width="50%"}

![](images/age_issue_csv.jpg){fig-alt="A csv file with text data in the Age column." fig-align="center" width="100%"}

:::

::::

## Automated capture of warnings (csv)

If there are issues with the data, the output of [`readr::problems`](https://readr.tidyverse.org/reference/problems.html){target="_blank"} will be a tibble.

```{r}
#| label: view problem in vroom
#| echo: true
#| warning: true

cohort_data_csv |> 
  vroom::problems()

```

To check for this automatically, we can use [`pointblank::expect_row_count_match`](https://rstudio.github.io/pointblank/reference/row_count_match.html){target="_blank"}.

```{r}
#| label: safeguard problem with vroom and pointblank
#| echo: true
#| error: true

cohort_data_csv |> 
  vroom::problems() |> 
  pointblank::expect_row_count_match(count = 0)

```

## Automated capture of warnings (csv)

Here is a case with no issues.

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: read data with no issues csv
#| echo: true
#| warning: true

cohort_data_csv <- vroom::vroom(
  file = here::here("data-raw", "Cohort_csv", 
    "data_to_harmonise_age_issue_fixed.csv"),
  delim = ",",
  col_select = 1:2,
  show_col_types = FALSE,
  col_types = list(
    ID = vroom::col_character(), 
    Age = vroom::col_integer()
  )
)

cohort_data_csv |> 
  vroom::problems()

```

```{r}
#| label: read data with no issues csv safeguard
#| echo: true
#| warning: true

cohort_data_csv |> 
  vroom::problems() |> 
  pointblank::expect_row_count_match(count = 0)

```

:::

::: {.column width="50%"}

![](images/age_issue_fixed_csv.jpg){fig-alt="A csv file with only integer data in the Age column." fig-align="center" width="100%"}

:::

::::

## Automated capture of warnings (Excel)

Is there an automated way to catch warnings/issues when reading Excel files ?

::: {.column width="50%"}

```{r}
#| label: read data with warnings Excel
#| echo: true
#| warning: true

cohort_data_excel <- readxl::read_excel(
  path = here::here("data-raw", "Cohort_Excel", 
    "data_to_harmonise_age_issue.xlsx"),
  sheet = "Sheet1",
  col_types = c(
    "text", "numeric"
    )
  )
```

:::

::: {.column width="50%"}

![](images/age_issue_excel.jpg){fig-alt="An Excel file with text data in the Age column." fig-align="center" width="100%"}

:::

## Automated capture of warnings (Excel)

We can read the Excel file with [`testthat::expect_no_condition`](https://testthat.r-lib.org/reference/expect_error.html){target="_blank"}.

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: read data with issues using testthat
#| echo: true
#| code-line-numbers: "|1,8"
#| error: true

testthat::expect_no_condition(
  cohort_data_excel <- readxl::read_excel(
    path = here::here("data-raw", "Cohort_Excel", 
      "data_to_harmonise_age_issue.xlsx"),
    sheet = "Sheet1",
    col_types = c("text", "numeric")
  )
)
```

:::

::: {.column width="50%"}

![](images/age_issue_excel.jpg){fig-alt="An Excel file with text data in the Age column." fig-align="center" width="100%"}

:::

::::

## Automated capture of warnings (Excel)

However, this method means that you will lose the pipe workflow.

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: read data without issues using testthat
#| echo: true

testthat::expect_no_condition(
  cohort_data_excel <- readxl::read_excel(
    path = here::here("data-raw", "Cohort_Excel", 
      "data_to_harmonise_age_issue_fixed.xlsx"),
    sheet = "Sheet1",
    col_types = c("text", "numeric")
  )
)

cohort_data_excel <- cohort_data_excel |> 
  # Check if Serial Number is unique
  pointblank::rows_distinct(
    columns = "Serial Number",
  )
```

:::

::: {.column width="50%"}

![](images/age_issue_fixed_excel.jpg){fig-alt="An Excel file with numeric data in the Age column." fig-align="center" width="100%"}

:::

::::

## Automated capture of warnings (Excel)

We can use the tee pipe operator [`%T>%`](https://magrittr.tidyverse.org/reference/tee.html){target="_blank"} from {{< fa brands r-project >}} üì¶ [magrittr](https://magrittr.tidyverse.org/){target="_blank"}.

:::: {.columns}

::: {.column width="50%"}

:::{.center-h}
[**With Issues**]{style="font-size: 80%;"}
:::

```{r}
#| label: read data with issues using testthat and tee pipe
#| echo: true
#| code-line-numbers: "|8,9"
#| error: true

cohort_data_excel <- readxl::read_excel(
  path = here::here("data-raw", "Cohort_Excel", 
    "data_to_harmonise_age_issue.xlsx"),
  sheet = "Sheet1",
  col_types = c(
    "text", "numeric"
    )
  ) %T>%
  testthat::expect_no_condition()
```

:::

::: {.column width="50%"}

:::{.center-h}
[**No Issues**]{style="font-size: 80%;"}
:::

```{r}
#| label: read data without issues using testthat and tee pipe
#| code-line-numbers: "|6,7"
#| echo: true

cohort_data_excel_2 <- readxl::read_excel(
  path = here::here("data-raw", "Cohort_Excel", 
    "data_to_harmonise_age_issue_fixed.xlsx"),
  sheet = "Sheet1",
  col_types = c("text", "numeric")
) %T>%
testthat::expect_no_condition() |> 
# Check if Serial Number is unique
  pointblank::rows_distinct(
    columns = "Serial Number",
)

```

:::

::::

## Variable Mapping

![](images/variable_mapping_workflow.png){fig-alt="Variable Mapping Reporting Workflow. Starting with introducing the mapping procedure, writing code to do mapping ans validation, showing that the code works, clean up data for merging." fig-align="center" width="100%"}

## Variable Mapping

Let take this data set as an example.

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: read csv data
#| echo: true

cohort_csv_data <- vroom::vroom(
  file = here::here("data-raw",
                    "Cohort_csv",
                    "data_to_harmonise.csv"),
  delim = ",",
  col_select = 1:8,
  show_col_types = FALSE,
  col_types = list(
    ID = vroom::col_character(),
    Age = vroom::col_integer(),
    Sex = vroom::col_character(),
    Height = vroom::col_double(),
    Weight = vroom::col_double(),
    `Smoke History` = vroom::col_character(),
    `Chest Pain Character` = vroom::col_character(),
    Dyspnea = vroom::col_character()
    )
  ) |>  
  dplyr::rename(cohort_unique_id = "ID") |>
  # Remove rows when the ID value is NA
  dplyr::filter(!is.na(.data[["cohort_unique_id"]])) |>
  # Remove white spaces in column names
  dplyr::rename_all(stringr::str_trim) |> 
  # Check if cohort id is unique
  pointblank::rows_distinct(
    columns = "cohort_unique_id",
  )

cohort_csv_data |> 
  vroom::problems() |> 
  pointblank::expect_row_count_match(count = 0)

```

:::

::: {.column width="50%"}

```{r}
#| label: print csv data
#| echo: false
 
cohort_csv_data |> 
  dplyr::mutate(
    Sex = forcats::fct_relevel(.data[["Sex"]], c("Male", "Female")),
    `Smoke History` = forcats::fct_relevel(
      .data[["Smoke History"]], 
      c("non-smoker", "past smoker", "current smoker")
    ),
    `Chest Pain Character` = forcats::fct_relevel(
      .data[["Chest Pain Character"]], 
      c("no chest pain", "nonanginal", "atypical", "typical")
    ),
    `Dyspnea` = forcats::fct_relevel(
      .data[["Dyspnea"]], 
      c("no", "yes")
    ),
  ) |> 
  reactable_with_download_csv_button(
    defaultPageSize = 5,
    paginationType = "jump",
    style = list(fontSize = "1rem"),
  )

```

:::

::::

## Variable Mapping

Let the reader know how the collaborator's data `Smoke History` is going to be mapped.

![](images/mapping_procedure.png){fig-alt="Documentation indicating how the collaborator's data Smoke History is going to be mapped or harmonised in Quarto code and output." fig-align="center" width="90%"}

## Variable Mapping

![](images/code_to_map.png){fig-alt="Code to do mapping." fig-align="center" width="30%"}

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: smoking data harmonisation
#| echo: true
#| code-line-numbers: "|2,3|5-14|15-24"

smoking_data <- cohort_csv_data |>
  dplyr::select(c("cohort_unique_id", 
                  "Smoke History")) |>
  dplyr::mutate(
    smoke_current = dplyr::case_when(
      is.na(.data[["Smoke History"]]) ~ "-1",
      .data[["Smoke History"]] == "non-smoker" ~ "0",
      .data[["Smoke History"]] == "past smoker" ~ "0",
      .data[["Smoke History"]] == "current smoker" ~ "1",
      .default = NA_character_
    ),
    smoke_current = forcats::fct_relevel(
      .data[["smoke_current"]],
      c("0", "1")), 
    smoke_past = dplyr::case_when(
      is.na(.data[["Smoke History"]]) ~ "-1",
      .data[["Smoke History"]] == "non-smoker" ~ "0",
      .data[["Smoke History"]] == "past smoker" ~ "1",
      .data[["Smoke History"]] == "current smoker" ~ "0",
      .default = NA_character_
    ),
    smoke_past = forcats::fct_relevel(
      .data[["smoke_past"]],
      c("0", "1")),
    `Smoke History` = forcats::fct(
      .data[["Smoke History"]]
    )
  )

```

:::

::: {.column width="50%"}

![](images/smoking_history_documentation.png){fig-alt="Documentation of harmonisation of smoking history." fig-align="center" width="100%"}

:::

::::

## Variable Mapping

![](images/code_to_validate.png){fig-alt="Code to do validation." fig-align="center" width="30%"}

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: smoking data validation
#| code-line-numbers: "|2-5|6-12"
#| echo: true

smoking_data <- smoking_data |>
  pointblank::col_vals_in_set(
    columns = c("smoke_current", "smoke_past"),
    set = c("0", "1", "-1")
  ) |> 
  pointblank::col_vals_expr(
    expr = pointblank::expr(
      (.data[["smoke_current"]] == "1" & .data[["smoke_past"]] == "0") |
      (.data[["smoke_current"]] == "-1" & .data[["smoke_past"]] == -"1") |
      (.data[["smoke_current"]] == "0" & .data[["smoke_past"]] %in% c("0", "1"))
    )
  )

```

:::

::: {.column width="50%"}

![](images/smoking_history_validation.png){fig-alt="Documentation of harmonisation of smoking history." fig-align="center" width="100%"}

:::

::::

[Reference: <https://github.com/rstudio/pointblank/issues/578>{target="_blank"}]{style="font-size: 80%;"}

## Variable Mapping

Make use of Quarto's [parameters](https://quarto.org/docs/computations/parameters.html){target="_blank"}, [conditional content](https://quarto.org/docs/authoring/conditional.html){target="_blank"} and `!expr` [knitr engine](https://quarto.org/docs/tools/rstudio.html#knitr-engine){target="_blank"} syntax to choose what code/items to run/display on your html, pdf or word report.

:::: {.columns}

::: {.column width="50%"}

![](images/example_works.png){fig-alt="Show examples that the code works." fig-align="center" width="100%"}

````{.r filename="your_quarto_script.qmd"}
---
params:
  show_table: TRUE
---

```{{r}}
#| label: output type
#| echo: false
#| warning: false
#| message: false

out_type <- knitr::opts_chunk$get("rmarkdown.pandoc.to")
```
````

:::

::: {.column width="50%"}

![](images/print_reactable.png){fig-alt="Code to print the reactable in html file." fig-align="center" width="100%"}

:::

::::

## Variable Mapping

{{< fa brands youtube >}} [Parameterized Quarto Reports Improve Understanding of Soil Health](https://www.youtube.com/watch?v=lbE5uOqfT70){target="_blank"} by [Jadey Ryan](https://jadeyryan.com/){target="_blank"}.

<iframe width="1000" height="500" src="https://www.youtube.com/embed/lbE5uOqfT70?si=kvtl0rbJt_jU4oBW" title="Parameterized Quarto Reports Improve Understanding of Soil Health" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

## Variable Mapping

:::: {.columns}

::: {.column width="50%"}

![](images/example_works.png){fig-alt="Show examples that the code works." fig-align="center" width="100%"}
![](images/print_reactable.png){fig-alt="Code to print the reactable in html file." fig-align="center" width="100%"}

:::

::: {.column width="50%"}

:::{.center-h}
[**Html Output**]{style="font-size: 80%;"}
:::

```{r}
#| label: smoking data html

smoking_data |> 
  reactable_with_download_csv_button(
    defaultPageSize = 5,
    paginationType = "jump",
    style = list(fontSize = "1rem"),
  )

```

:::

::::

## Variable Mapping

:::: {.columns}

::: {.column width="50%"}

![](images/example_works.png){fig-alt="Show examples that the code works." fig-align="center" width="100%"}
![](images/print_code_pdf.png){fig-alt="Code to print the table in pdf file." fig-align="center" width="100%"}

:::

::: {.column width="50%"}

:::{.center-h}
[**Pdf Output**]{style="font-size: 80%;"}
:::

![](images/print_pdf.png){fig-alt="Output code in pdf file." fig-align="center" width="100%"}

![](images/print_pdf_2.png){fig-alt="Output table in pdf file." fig-align="center" width="100%"}
:::

::::

## Variable Mapping

:::: {.columns}

::: {.column width="50%"}

![](images/clean_for_merging.png){fig-alt="Clean for merging." fig-align="center" width="50%"}
```{r}
#| label: smoking data for merging
#| echo: true

smoking_data <- smoking_data |>
  dplyr::select(-c("Smoke History"))

```

:::

::: {.column width="50%"}

```{r}
#| label: smoking data for merging html

smoking_data |> 
  reactable_with_download_csv_button(
    defaultPageSize = 5,
    paginationType = "jump",
    style = list(fontSize = "1rem"),
  )

```

:::

::::

## Merging Harmonised Data

Suppose we have completed harmonising a batch of clinical data.

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: age gender data

age_gender_data <- cohort_csv_data |>
  dplyr::select(c("cohort_unique_id", 
                  "Age", 
                  "Sex")) |>
  pointblank::col_vals_expr(
    expr = ~is_integer_vector(
      cohort_A_data[["age"]],
      allow_na = TRUE)
  ) |>
  dplyr::mutate(
    # Convert age to type integer
    age_years = as.integer(.data[["Age"]]),
    # Convert categorical columns to factors
    sex = dplyr::case_when(
      .data[["Sex"]] == "Female" ~ "0",
      .data[["Sex"]] == "Male" ~ "1",
      .default = NA_character_
    ),
    `Sex` = forcats::fct_relevel(
      .data[["Sex"]],
      c("Female", "Male")
    ),
    sex = forcats::fct_relevel(
      .data[["sex"]],
      c("0", "1")),
  ) |>
  dplyr::relocate(
    "sex",
    .before = "Sex"
  ) |> 
  dplyr::relocate(
    "age_years",
    .after = "Age"
  ) |>
  pointblank::col_vals_in_set(
    columns = "sex",
    set = c("0", "1")
  ) |> 
  pointblank::col_vals_between(
    columns = "age_years",
    left = 0,
    right = 100,
    inclusive = c(FALSE, TRUE),
    na_pass = TRUE
  ) |>
  dplyr::select(-c("Age", "Sex"))

```

```{r}
#| label: age gender data for merging html
#| echo: true

age_gender_data |> 
  reactable_with_download_csv_button(
    defaultPageSize = 5,
    paginationType = "jump",
    style = list(fontSize = "1rem"),
  )

```

:::

::: {.column width="50%"}

```{r}
#| label: body measurement data

body_measurement_data <- cohort_csv_data |>
  dplyr::select(c("cohort_unique_id", 
                  "Height", "Weight")) |>
  dplyr::mutate(
    height_cm = .data[["Height"]],
    weight_kg = .data[["Weight"]],
    bsa_m2 = sqrt((.data[["height_cm"]] * .data[["weight_kg"]]) / 3600),
    bsa_m2 = round_to_nearest_digit(.data[["bsa_m2"]], digits = 2),
    bmi = .data[["weight_kg"]] / ((.data[["height_cm"]] / 100)^2),
    bmi = round_to_nearest_digit(.data[["bmi"]], digits = 2),
    height_cm = round_to_nearest_digit(.data[["height_cm"]], digits = 2),
    weight_kg = round_to_nearest_digit(.data[["weight_kg"]], digits = 2)
  ) |> 
  pointblank::col_vals_between(
    columns = "bmi",
    left = 10,
    right = 50,
    inclusive = c(TRUE, TRUE),
    na_pass = TRUE
  ) |>
  dplyr::select(-c("Height", "Weight"))

```

```{r}
#| label: body measurement data for merging html
#| echo: true

body_measurement_data |> 
  reactable_with_download_csv_button(
    defaultPageSize = 5,
    paginationType = "jump",
    style = list(fontSize = "1rem"),
  )

```

:::

::::

How can we merge them without issues of missing rows or additional columns ?

## Merging Harmonised Data

`unmatched = "error"` in [`dplyr::inner_join`](https://dplyr.tidyverse.org/reference/mutate-joins.html){target="_blank"} helps to avoid patients with no match.

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: demo behave data no match in y
#| code-line-numbers: "|4|7,11,15"
#| echo: true

join_specification <- dplyr::join_by("cohort_unique_id")

demo_behave_data <- cohort_csv_data |>
  dplyr::select(c("cohort_unique_id")) |>
  dplyr::inner_join(age_gender_data,
                   by = join_specification,
                   unmatched = "error",
                   relationship = "one-to-one") |>
  dplyr::inner_join(body_measurement_data,
                   by = join_specification,
                   unmatched = "error",
                   relationship = "one-to-one") |>
  dplyr::inner_join(smoking_data,
                   by = join_specification,
                   unmatched = "error",
                   relationship = "one-to-one") |>
  dplyr::relocate(c("bsa_m2", "bmi"),
                  .after = "sex")

```

:::

::: {.column width="50%"}

```{r}
#| label: penguin error no match in y
#| echo: true
#| code-line-numbers: "|3-4,11,18"
#| warning: true
#| error: true

three_penguins <- tibble::tribble(
  ~samp_id, ~species,    ~island,
  1,        "Adelie",    "Torgersen",
  2,        "Gentoo",    "Biscoe",
)

weight_extra <- tibble::tribble(
  ~samp_id,  ~body_mass_g,
  1,         3220,
  2,         4730,
  4,         4725
)

three_penguins |> 
  dplyr::inner_join(
    y = weight_extra,
    by = dplyr::join_by("samp_id"),
    unmatched = "error"
 ) 

```

:::

::::

[Reference: <https://www.tidyverse.org/blog/2023/08/teach-tidyverse-23/#improved-and-expanded-_join-functionality>]{style="font-size: 80%;"}

## Merging Harmonised Data

`unmatched = "error"` in [`dplyr::inner_join`](https://dplyr.tidyverse.org/reference/mutate-joins.html){target="_blank"} helps to avoid patients with no match.

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: demo behave data no match in x
#| code-line-numbers: "|7,11,15"
#| echo: true

join_specification <- dplyr::join_by("cohort_unique_id")

demo_behave_data <- cohort_csv_data |>
  dplyr::select(c("cohort_unique_id")) |>
  dplyr::inner_join(age_gender_data,
                   by = join_specification,
                   unmatched = "error",
                   relationship = "one-to-one") |>
  dplyr::inner_join(body_measurement_data,
                   by = join_specification,
                   unmatched = "error",
                   relationship = "one-to-one") |>
  dplyr::inner_join(smoking_data,
                   by = join_specification,
                   unmatched = "error",
                   relationship = "one-to-one") |>
  dplyr::relocate(c("bsa_m2", "bmi"),
                  .after = "sex")

```

:::

::: {.column width="50%"}

```{r}
#| label: penguin error no match in x
#| echo: true
#| code-line-numbers: "|4,10,11,18"
#| warning: true
#| error: true

three_penguins <- tibble::tribble(
  ~samp_id, ~species,    ~island,
  1,        "Adelie",    "Torgersen",
  2,        "Gentoo",    "Biscoe",
  3,        "Chinstrap", "Dream"
)

weight_extra <- tibble::tribble(
  ~samp_id,  ~body_mass_g,
  1,         3220,
  3,         4725
)

three_penguins |> 
  dplyr::inner_join(
    y = weight_extra,
    by = dplyr::join_by("samp_id"),
    unmatched = "error"
 ) 

```

:::

::::

[Reference: <https://www.tidyverse.org/blog/2023/08/teach-tidyverse-23/#improved-and-expanded-_join-functionality>]{style="font-size: 80%;"}

## Merging Harmonised Data

`relationship = "one-to-one"` in [`dplyr::inner_join`](https://dplyr.tidyverse.org/reference/mutate-joins.html){target="_blank"} helps to avoid patients with multiple match.

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: demo behave data 2
#| code-line-numbers: "|8,12,16"
#| echo: true

join_specification <- dplyr::join_by("cohort_unique_id")

demo_behave_data <- cohort_csv_data |>
  dplyr::select(c("cohort_unique_id")) |>
  dplyr::inner_join(age_gender_data,
                   by = join_specification,
                   unmatched = "error",
                   relationship = "one-to-one") |>
  dplyr::inner_join(body_measurement_data,
                   by = join_specification,
                   unmatched = "error",
                   relationship = "one-to-one") |>
  dplyr::inner_join(smoking_data,
                   by = join_specification,
                   unmatched = "error",
                   relationship = "one-to-one") |>
  dplyr::relocate(c("bsa_m2", "bmi"),
                  .after = "sex")

```

:::

::: {.column width="50%"}

```{r}
#| label: penguin error 2
#| echo: true
#| code-line-numbers: "|4,11,12,20"
#| warning: true
#| error: true

three_penguins <- tibble::tribble(
  ~samp_id, ~species,    ~island,
  1,        "Adelie",    "Torgersen",
  2,        "Gentoo",    "Biscoe",
  3,        "Chinstrap", "Dream"
)

weight_extra <- tibble::tribble(
  ~samp_id,  ~body_mass_g,
  1,         3220,
  2,         4730,
  2,         4725,
  3,         4000
)

three_penguins |> 
  dplyr::inner_join(
    y = weight_extra,
    by = dplyr::join_by("samp_id"),
    relationship = "one-to-one"
 ) 

```

:::

::::

[Reference: <https://www.tidyverse.org/blog/2023/08/teach-tidyverse-23/#improved-and-expanded-_join-functionality>]{style="font-size: 80%;"}

## Merging Harmonised Data 

Use [`pointblank::has_columns`](https://rstudio.github.io/pointblank/reference/has_columns.html){target="_blank"} to ensure we only have harmonised variables.

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: demo behave data validation
#| echo: true

testthat::expect_false(
  pointblank::has_columns(
    demo_behave_data,
    columns = c(
      dplyr::ends_with(".x"), 
      dplyr::ends_with(".y")
    )
  )
)

testthat::expect_equal(
  ncol(demo_behave_data), 9
)

testthat::expect_true(
  pointblank::has_columns(
    demo_behave_data,
    columns = c(
      "age_years", "sex",
      "height_cm", "weight_kg", "bsa_m2", "bmi",
      "smoke_current", "smoke_past"
    )
  )
) 

```

:::

::: {.column width="50%"}

```{r}
#| label: penguin error 3
#| echo: true
#| code-line-numbers: "|2,9|24-29"
#| warning: true
#| error: true

three_penguins <- tibble::tribble(
  ~samp_id, ~species,    ~island,
  1,        "Adelie",    "Torgersen",
  2,        "Gentoo",    "Biscoe",
  3,        "Chinstrap", "Dream"
)

weight_extra <- tibble::tribble(
  ~samp_id,  ~island,
  1,         "Torgersen",
  2,         "Biscoe",
  3,         "Dream"
)

three_penguins <- three_penguins |> 
  dplyr::inner_join(
    y = weight_extra,
    by = dplyr::join_by("samp_id"),
    unmatched = "error",
    relationship = "one-to-one"
 )

three_penguins |> 
  pointblank::has_columns(
    columns = c(
      dplyr::ends_with(".x"), 
      dplyr::ends_with(".y")
      )
  )

colnames(three_penguins)

```

:::

::::

## Comapring Datasets

Use {{< fa brands r-project >}} üì¶ [`daff`](https://davidgohel.github.io/flextable/){target="_blank"} to compare different version of harmonised datasets.

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: daff intro example
#| echo: true

data1 <- data.frame(
  Name=c("P1","P2","P3","P4","P5"),
  col1=c(1,2,3,4,5),
  col2=c(11,13,14,15,17)
)

data2 <- data.frame(
  col1=c(1,3,3,6,9), 
  Name=c("P1","P2","P6","P4","P5")
)

compare_results <- daff::diff_data(data1, data2)
compare_results
```

:::

::: {.column width="50%"}

```{r}
#| label: daff output
#| echo: true
#| eval: false

daff::render_diff(compare_results)
```

![](images/daff_image.png){fig-alt="Interactive results from daff." fig-align="center" width="87%"}
:::

::::

## Comapring Datasets

Use `summary()` to return a summary list.

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: daff different example
#| echo: true

data1 <- data.frame(
  Name=c("P1","P2","P3","P4","P5"),
  col1=c(1,2,3,4,5),
  col2=c(11,13,14,15,17)
)

data2 <- data.frame(
  col1=c(1,3,3,6,9), 
  Name=c("P1","P2","P6","P4","P5")
)

compare_different_summary <- daff::diff_data(
  data1, data2) |> 
  summary()

compare_different_summary
```

:::

::: {.column width="50%"}

```{r}
#| label: daff same example
#| echo: true

data1 <- data.frame(
  Name=c("P1","P2","P3","P4","P5"),
  col1=c(1,2,3,4,5),
  col2=c(11,13,14,15,17)
)

data2 <- data.frame(
  Name=c("P1","P2","P3","P4","P5"),
  col1=c(1,2,3,4,5),
  col2=c(11,13,14,15,17)
)

compare_same_summary <- daff::diff_data(data1, data2) |> 
  summary()

compare_same_summary
```

:::

::::

## Comapring Datasets

Use the summary list and [`pointblank::expect_col_vals_in_set`](https://rstudio.github.io/pointblank/reference/col_vals_in_set.html){target="_blank"} to do the validation automatically.

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: daff different example with pointblank
#| echo: true
#| error: true

tibble::tibble(
  row_deletes = compare_different_summary$row_deletes,
  row_inserts = compare_different_summary$row_inserts,
  row_updates = compare_different_summary$row_updates,
  row_reorders = compare_different_summary$row_reorders,
  col_deletes = compare_different_summary$col_deletes,
  col_inserts = compare_different_summary$col_inserts,
  col_updates = compare_different_summary$col_updates,
  col_reorders = compare_different_summary$col_reorders,
) |>
  pointblank::expect_col_vals_in_set(
    columns = c(
      "row_deletes", "row_inserts", "row_updates", "row_reorders",
      "col_deletes", "col_inserts", "col_updates", "col_reorders"
    ),
    set = c(0)
  )
```

:::

::: {.column width="50%"}

```{r}
#| label: daff same example with pointblank
#| echo: true
#| error: true

tibble::tibble(
  row_deletes = compare_same_summary$row_deletes,
  row_inserts = compare_same_summary$row_inserts,
  row_updates = compare_same_summary$row_updates,
  row_reorders = compare_same_summary$row_reorders,
  col_deletes = compare_same_summary$col_deletes,
  col_inserts = compare_same_summary$col_inserts,
  col_updates = compare_same_summary$col_updates,
  col_reorders = compare_same_summary$col_reorders,
) |>
  pointblank::expect_col_vals_in_set(
    columns = c(
      "row_deletes", "row_inserts", "row_updates", "row_reorders",
      "col_deletes", "col_inserts", "col_updates", "col_reorders"
    ),
    set = c(0)
  )
```

:::

::::

## Comapring Datasets

{{< fa brands youtube >}}[Find the difference between two datasets in R](https://www.youtube.com/watch?v=bKYUHFYAjtc){target="_blank"}

<iframe width="1000" height="500" src="https://www.youtube.com/embed/bKYUHFYAjtc?si=sPX9Eicva5B1Rh-x" title="Find the difference between two datasets in R" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

## Tehcncal Report Challenge

:::: {.columns}

::: {.column width="50%"}

:::{.fragment}

One variable mapping report takes at least one page.

:::

:::{.fragment}

On average, a clinical trial will have a few hundred variables.

* [One hundred columns for clinical and demographics.]{style="font-size: 80%;"}
* [Two hundred columns for medication.]{style="font-size: 80%;"}

:::

:::{.fragment}

Harmonisation report can have at least a few hundreds pages for each cohort.

There is a need to automate the creation of these reports.

:::

:::

::: {.column width="50%"}

![](images/overload.jpg){fig-alt="Businessman in pile of documents asking for help." fig-align="center" width="87%"}

[Businessman in pile of documents asking for help by [Amonrat Rungreangfangsai](https://www.vecteezy.com/vector-art/464741-businessman-in-pile-of-documents-asking-for-help-over-workload){target="_blank"}]{style="font-size: 60%;"}

:::

::::

## Quarto Books/Websites

```{=html}
<iframe width="1000" height="550" src="https://jauntyjjs-harmonisation-cohort-b.netlify.app/" title="Cohort_B Harmonisation Report in html" ></iframe>
```

## Quarto Level 3

To make a Quarto book or website, we need a `_quarto.yml` and `index.qmd` file

:::: {.columns}

::: {.column width="50%"}

![](images/quarto_yml.png){fig-alt="A preview of the _quarto.yml file." fig-align="center" width="100%"}

:::

::: {.column width="50%"}

![](images/index_qmd.png){fig-alt="A preview of the index.qmd file." fig-align="center" width="100%"}

:::

::::

## Quarto Level 3

`_quarto.yml` is a [configuration file](https://quarto.org/docs/projects/quarto-projects.html){target="_blank"} to tell Quarto to create a book.

````{.yaml filename="_quarto.yml"}
---
project:
  type: book
  output-dir: reports/Cohort_B

book:
  downloads: [pdf, docx]
  title: "Harmonisation Template for Cohort B"
  author: "My Name"
  navbar:
    search: true
  sidebar:
    collapse-level: 1

  chapters:
    - index.qmd
    - part: Cohort B Cleaning
      chapters:
        - codes/Cohort_B/00_R_Package_And_Environment.qmd
        - codes/Cohort_B/01_Read_Cohort_B_Data.qmd
        - codes/Cohort_B/02_Extract_Demographic.qmd
        - codes/Cohort_B/03_Export_To_Excel.qmd

crossref:
  chapters: false
  fig-title: Figure     # (default is "Figure")
  tbl-title: Table      # (default is "Table")
  fig-prefix: Figure    # (default is "Figure")
  tbl-prefix: Table     # (default is "Table")
  ref-hyperlink: true   # (default is true)
  title-delim: ":"      # (default is ":")

bibliography: references.bib
csl: csl_file.csl

format:
  html:
    toc: true
    toc-depth: 5
    toc-location: right
    toc-expand: true
    number-sections: true
    number-depth: 5
    smooth-scroll: true
    theme:
      light:
        - flatly
        #- custom.scss
      dark:
        - solar
  docx:
    reference-doc: custom-reference.docx
    toc: true
    toc-depth: 5
    number-sections: true
    number-depth: 5
    prefer-html: true
    highlight-style: github
  pdf:
    pdf-engine: xelatex
    documentclass: scrreprt
    papersize: a4
    toc-depth: 5
    number-sections: true
    number-depth: 5
    keep-tex: false
    include-in-header:
      text: |
        \usepackage{fvextra}
        \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
        \DefineVerbatimEnvironment{OutputCode}{Verbatim}{breaklines,commandchars=\\\{\}}
    include-before-body:
      text: |
        \begin{flushleft}
        \begin{sloppypar}
        \RecustomVerbatimEnvironment{verbatim}{Verbatim}{
          showspaces = false,
          showtabs = false,
          breaksymbolleft={}, % Need pacakge fvextra
          breaklines
          % Note: setting commandchars=\\\{\} here will cause an error
        }
    include-after-body:
      text: |
        \end{sloppypar}
        \end{flushleft}
---
````

## Quarto Level 3

`index.qmd` file gives the preface (homepage) content of the Quarto book (website). It is [compulsory](https://quarto.org/docs/books/book-structure.html){target="_blank"} file needed for the rendering to work.

````{.r filename="index.qmd"}
---
date: "2025-03-10"
format:
  html:
    code-fold: true
    freeze: false
params:
  show_table: TRUE
---

```{{r}}
#| label: output type
#| echo: false
#| warning: false
#| message: false

out_type <- knitr::opts_chunk$get("rmarkdown.pandoc.to")
```

# Preface {.unnumbered .unlisted}

Here is the documentation of the data harmonisation step generated using [Quarto](https://quarto.org/). To learn more about Quarto books visit <https://quarto.org/docs/books>.

## File Structure

Here is the file structure of the project used to generate the document.

```
harmonisation/                            # Root of the project template.
|
‚îú‚îÄ‚îÄ .quarto/ (not in repository)          # Folder to keep intermediate files/folders 
|                                         # generated when Quarto renders the files.
|
‚îú‚îÄ‚îÄ archive/                              # Folder to keep previous books and harmonised data.
|   |
‚îÇ   ‚îú‚îÄ‚îÄ reports/                          # Folder to keep previous versions of
|   |   |                                 # data harmonisation documentation.
|   |   |
|   |   ‚îú‚îÄ‚îÄ {some_date}_batch/            # Folder to keep {some_date} version of
|   |   |                                 # data harmonisation documentation.
|   |   |
|   |   ‚îî‚îÄ‚îÄ Flowchart.xlsx                # Flowchart sheet to record version control.
|   |
|   ‚îî‚îÄ‚îÄ harmonised/                       # Folder to keep previous version of harmonised data.
|       |
|       ‚îú‚îÄ‚îÄ {some_date}_batch/            # Folder to keep {some_date} version of
|       |                                 # harmonised data.
|       |
|       ‚îî‚îÄ‚îÄ Flowchart.xlsx                # Flowchart sheet to record version control.
|
‚îú‚îÄ‚îÄ codes/                                # Folder to keep R/Quarto scripts 
|   |                                     # to run data harmonisation.
|   |
‚îÇ   ‚îú‚îÄ‚îÄ {cohort name}/                    # Folder to keep Quarto scripts to run
|   |   |                                 # data cleaning, harmonisation 
|   |   |                                 # and output them for each cohort.
|   |   |
|   |   ‚îî‚îÄ‚îÄ preprocessed_data/            # Folder to keep preprocessed data.
|   |
‚îÇ   ‚îú‚îÄ‚îÄ harmonisation_summary/            # Folder to keep Quarto scripts to create
|   |                                     # data harmonisation summary report.
|   |
‚îÇ   ‚îú‚îÄ‚îÄ output/                           # Folder to keep harmonised data.
|   |                                     
|   ‚îú‚îÄ‚îÄ cohort_harmonisation_script.R     # R script to render each {cohort name}/ folder. 
|   |                                     # folder into html, pdf and word document.
|   |
|   ‚îî‚îÄ‚îÄ harmonisation_summary_script.R    # R script to render the {harmonisation_summary}/ 
|                                         # folder into word document.
‚îÇ  
‚îú‚îÄ‚îÄ data-raw/                             # Folder to keep cohort raw data (.csv, .xlsx, etc.)
|   |
‚îÇ   ‚îú‚îÄ‚îÄ {cohort name}/                    # Folder to keep cohort raw data.
|   |   |
|   |   ‚îú‚îÄ‚îÄ {data_dictionary}             # Data dictionary file that correspond to the 
|   |   |                                 # cohort raw data. Can be one from the
|   |   |                                 # collaborator provide or provided by us.
|   |   |
|   |   ‚îî‚îÄ‚îÄ Flowchart.xlsx                # Flowchart sheet to record version control.
|   |
|   ‚îú‚îÄ‚îÄ data-dictionary/                  # Folder to keep data dictionary 
|   |   |                                 # used for harmonising data.
|   |   |
|   |   ‚îî‚îÄ‚îÄ Flowchart.xlsx                # Flowchart sheet to record version control.
|   |
|   ‚îî‚îÄ‚îÄ data-input/                       # Folder to keep data input file 
|       |                                 # for collaborators to fill in.
|       |
|       ‚îî‚îÄ‚îÄ Flowchart.xlsx                # Flowchart sheet to record version control.
|  
‚îú‚îÄ‚îÄ docs/                                 # Folder to keep R functions documentation 
|                                         # generated using pkgdown:::build_site_external().
|  
‚îú‚îÄ‚îÄ inst/                                 # Folder to keep arbitrary additional files 
|   |                                     # to include in the project.
|   |  
|   ‚îî‚îÄ‚îÄ WORDLIST                          # File generated by spelling::update_wordlist()
|  
‚îú‚îÄ‚îÄ man/                                  # Folder to keep R functions documentation
|   |                                     # generated using devtools::document().
|   |
‚îÇ   ‚îú‚îÄ‚îÄ {fun-demo}.Rd                     # Documentation of the demo R function.
|   |
‚îÇ   ‚îî‚îÄ‚îÄ harmonisation-template.Rd         # High-level documentation.
|  
‚îú‚îÄ‚îÄ R/                                    # Folder to keep R functions.
|   |
‚îÇ   ‚îú‚îÄ‚îÄ {fun-demo}.R                      # Script with R functions.
|   |
‚îÇ   ‚îî‚îÄ‚îÄ harmonisation-package.R           # Dummy R file for high-level documentation.
‚îÇ  
‚îú‚îÄ‚îÄ renv/ (not in repository)             # Folder to keep all packages 
|                                         # installed in the renv environment.
| 
‚îú‚îÄ‚îÄ reports/                              # Folder to keep the most recent data harmonisation
|                                         # documentation.
|
‚îú‚îÄ‚îÄ templates/                            # Folder to keep template files needed to generate
|   |                                     # data harmonisation documentation efficiently.
|   |
|   ‚îú‚îÄ‚îÄ quarto-yaml/                      # Folder to keep template files to generate 
|   |   |                                 # data harmonisation documentation structure 
|   |   |                                 # in Quarto. 
|   |   |
‚îÇ   |   ‚îú‚îÄ‚îÄ _quarto_{cohort name}.yml     # Quarto book template data harmonisation documentation 
|   |   |                                 # for {cohort name}.
|   |   |
|   |   ‚îî‚îÄ‚îÄ _quarto_summary.yml           # Quarto book template data harmonisation summary.
|   |
|   ‚îî‚îÄ‚îÄ index-qmd/                        # Folder to keep template files to generate
|       |                                 # the preface page of the data harmonisation 
|       |                                 # documentation.
|       |
|       ‚îú‚îÄ‚îÄ _index_report.qmd             # Preface template for each cohort data harmonisation
|       |                                 # report. 
|       |
|       ‚îî‚îÄ‚îÄ _index_summary.qmd            # Preface template for data harmonisation 
|                                         # summary report. 
|        
‚îú‚îÄ‚îÄ tests/                                # Folder to keep test unit files. 
|                                         # Files will be used by R package testhat.
|
‚îú‚îÄ‚îÄ .Rbuildignore                         # List of files/folders to be ignored while 
‚îÇ                                         # checking/installing the package.
|
‚îú‚îÄ‚îÄ .Renviron (not in repository)         # File to set environment variables.
|
‚îú‚îÄ‚îÄ .Rprofile (not in repository)         # R code to be run when R starts up.
|                                         # It is run after the .Renviron file is sourced.
|
‚îú‚îÄ‚îÄ .Rhistory (not in repository)         # File containing R command history.
|
‚îú‚îÄ‚îÄ .gitignore                            # List of files/folders to be ignored while 
‚îÇ                                         # using the git workflow.
|
‚îú‚îÄ‚îÄ .lintr                                # Configuration for linting
|                                         # R projects and packages using linter.
|        
‚îú‚îÄ‚îÄ .renvignore                           # List of files/folders to be ignored when 
‚îÇ                                         # renv is doing its snapshot.
|
‚îú‚îÄ‚îÄ DESCRIPTION[*]                        # Overall metadata of the project.
|
‚îú‚îÄ‚îÄ LICENSE                               # Content of the MIT license generated via
|                                         # usethis::use_mit_license().
|
‚îú‚îÄ‚îÄ LICENSE.md                            # Content of the MIT license generated via
|                                         # usethis::use_mit_license().
|
‚îú‚îÄ‚îÄ NAMESPACE                             # List of functions users can use or imported
|                                         # from other R packages. It is generated 
|                                         # by devtools::document().
‚îÇ        
‚îú‚îÄ‚îÄ README.md                             # GitHub README markdown file generated by Quarto.
|
‚îú‚îÄ‚îÄ README.qmd                            # GitHub README quarto file used to generate README.md. 
|        
‚îú‚îÄ‚îÄ _pkgdown.yml                          # Configuration for R package documentation
|                                         # using pkgdown:::build_site_external().
|        
‚îú‚îÄ‚îÄ _quarto.yml                           # Configuration for Quarto book generation.
|                                         # It is also the project configuration file.
|
‚îú‚îÄ‚îÄ csl_file.csl                          # Citation Style Language (CSL) file to ensure
|                                         # citations follows the Lancet journal.
|        
‚îú‚îÄ‚îÄ custom-reference.docx                 # Microsoft word template for data harmonisation 
|                                         # documentation to Word.
|
‚îú‚îÄ‚îÄ harmonisation_template.Rproj          # RStudio project file.
|        
‚îú‚îÄ‚îÄ index.qmd                             # Preface page of Quarto book content.
|        
‚îú‚îÄ‚îÄ references.bib                        # Bibtex file for Quarto book.
|      
‚îî‚îÄ‚îÄ renv.lock                             # Metadata of R packages installed generated
                                          # using renv::snapshot().

[*] These files are automatically created but user needs to manually add some information.
```
````

## Quarto (Reference)

<https://quarto.org/>{target="_blank"}

```{=html}
<iframe width="1000" height="550" src="https://quarto.org/" title="Quarto Homepage" ></iframe>
```

## Harmonisation Report Types

Collaborator wants different ways to report how data harmonisation is done.

![](images/documentation_types.png){fig-alt="Four major documentation type." fig-align="center" width="80%"}

[The documentation system by [Divio](https://docs.divio.com/documentation-system/){target="_blank"}]{style="font-size: 60%;"}


## Harmonisation Report Types

Collaborator wants different ways to report how data harmonisation is done.

![](images/documentation_types_for_harmonisation.png){fig-alt="Four major documentation type in terms of data harmonisation" fig-align="center" width="80%"}


## Automated Technical Report (Reference)

[We create a `_quarto.yml` file and relevant Quarto files for each cohort.]{style="font-size: 80%;"}

![](images/report_for_cohort_A.png){fig-alt="A preview of the _quarto.yml and relevant Quarto files for Cohort A." fig-align="center" width="60%"}

## Automated Technical Report (Reference)

[We create an `index.qmd` file for each kind of report.]{style="font-size: 80%;"}

![](images/index_report_qmd.png){fig-alt="A preview of the index qmd file for technical reporting." fig-align="center" width="50%"}

## Automated Technical Report (Reference)

Create a script to generate technical reports in pdf, word and html for each cohort.

:::: {.columns}

::: {.column width="30%"}

```{r}
#| label: copy index report qmd
#| echo: true
#| eval: false

# Copy the right index.qmd 
# file

index_qmd_file <- paste0(
  "_index_",
  "report",
  ".qmd"
)

fs::file_copy(
  path = here::here(
    "templates",
    "index-qmd",
    index_qmd_file),
  new_path = here::here(
    "index.qmd"
  ),
  overwrite = TRUE
)

```

:::

::: {.column width="70%"}

![](images/index_qmd_copy.png){fig-alt="index_report.qmd file copied and changed to index.qmd" fig-align="center" width="100%"}
:::

::::

## Automated Technical Report (Reference)

Create a script to generate technical reports in pdf, word and html for each cohort.

:::: {.columns}

::: {.column width="30%"}

```{r}
#| label: automated report
#| echo: true
#| eval: false
#| code-line-numbers: "|5-21|23-26|29-37"


copy_and_render <- function(
    cohort
) {

  # Copy quarto.yml file
  # for each cohort
  
  quarto_yml_file <- paste0(
    "_quarto_",
    cohort,
    ".yml"
  )

  fs::file_copy(
    path = here::here(
      "templates",
      "quarto-yaml",
      quarto_yml_file),
    new_path = here::here("_quarto.yml"),
    overwrite = TRUE
  )
  
  # Render each cohort
  quarto::quarto_render(
    as_job = FALSE
  )
}

cohort_name <- c("Cohort_A", 
                 "Cohort_B")

purrr::walk(
  .x = cohort_name,
  .f = ~copy_and_render(
    cohort = .x
  )
)

```

:::

::: {.column width="70%"}

![](images/quarto_yml_copy.png){fig-alt="_quarto_Cohort_A.yml file copied and changed to _quarto.qmd" fig-align="center" width="100%"}
:::

::::

## Automated Technical Report (Reference)

![](images/technical_report.png){fig-alt="Output of technical report." fig-align="center" width="80%"}


## Automated Summary Report (How-to-Guide)

[A similar method is done to create a summary report in word using {{< fa brands r-project >}} üì¶ [`flextable`](https://davidgohel.github.io/flextable/){target="_blank"}.]{ style="font-size: 80%;"}

![](images/summary_report.png){fig-alt="Preview of summary report." fig-align="center" width="80%"}

## Overview Diagrams

How many variables can each cohort provide ? 

How many variables can be harmonised ?

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: Venn Diagram
#| echo: true
#| eval: true
#| output: false

demographic_list <- list(
  A = c("Age", "Sex",
        "Hypertension", "Dyslipidemia", "Family Hx CAD", "Diabetes",
        "Smoke Current", "Smoke Past",
        "Have Chest Pain", "Chest Pain Character",
        "Dyspnea",
        "BMI", "Height", "Weight"),
  B = c("Age", "Sex",
        "Hypertension", "Dyslipidemia", "Family Hx CAD", "Diabetes",
        "Smoke Current", "Smoke Past",
        "Have Chest Pain", "Chest Pain Character",
        "Dyspnea",
        "HDL", "Total Cholesterol", 
        "Triglyceride", "LDL"),
  C = c("Age", "Sex",
        "Hypertension", "Dyslipidemia", "Family Hx CAD", "Diabetes",
        "Smoke Current", "Smoke Past",
        "Have Chest Pain", "Chest Pain Character",
        "Dyspnea",
        "BMI", "Height", "Weight",
        "HDL", "Total Cholesterol", 
        "Triglyceride", "LDL")
)  

cohort_a_label_name <- "Cohort A\n(n=1000)"
cohort_b_label_name <- "Cohort B\n(n=2000)"
cohort_c_label_name <- "Cohort C\n(n=1500)"

demographic_venn_data <- demographic_list |> 
  ggVennDiagram::Venn() |> 
  ggVennDiagram::process_data()

demographic_venn_regionedge_data <- demographic_venn_data |> 
  ggVennDiagram::venn_regionedge() |> 
  dplyr::mutate(
    name = stringr::str_replace_all(
      .data[["name"]],
      "/",
      " and "
    ),
    name = stringr::str_wrap(.data[["name"]], width = 10),
    name = forcats::fct_reorder(.data[["name"]],
                                nchar(.data[["id"]]))
  ) |> 
  dplyr::rename(`Cohort` = "name")

demographic_venn_label_data <- demographic_venn_data |>
  ggVennDiagram::venn_setlabel() |> 
  dplyr::mutate(
    name = dplyr::case_match(
      .data[["name"]],
      "A" ~ cohort_a_label_name,
      "B" ~ cohort_b_label_name,
      "C" ~ cohort_c_label_name
    )
  ) |> 
  dplyr::rename(`Cohort` = "name")

demographic_venn_regionlabel_data <- demographic_venn_data |> 
  ggVennDiagram::venn_regionlabel() |> 
  dplyr::mutate(
    name = stringr::str_replace_all(
      .data[["name"]],
      "/",
      " and "
    ),
    name = stringr::str_wrap(.data[["name"]], width = 10),
    name = forcats::fct_reorder(.data[["name"]],
                                nchar(.data[["id"]]))
  ) |> 
  dplyr::rename(`Cohort` = "name")

demographic_venn_edge_data <- demographic_venn_data |> 
  ggVennDiagram::venn_setedge()

demographic_venn_diagram <- ggplot2::ggplot() +
  # 1. region count layer
  ggplot2::geom_polygon(
    data = demographic_venn_regionedge_data,
    mapping = ggplot2::aes(
      x = .data[["X"]], y = .data[["Y"]],
      fill = .data[["Cohort"]],
      group = .data[["id"]])
  ) +
  # 2. set edge layer
  ggplot2::geom_path(
    data = demographic_venn_edge_data,
    mapping = ggplot2::aes(
      x = .data[["X"]], y = .data[["Y"]],
      colour = "black",
      group = .data[["id"]]
    ),    
    show.legend = FALSE
  ) +
  # 3. set label layer
  ggplot2::geom_text(
    data = demographic_venn_label_data,
    mapping = ggplot2::aes(
      x = .data[["X"]], y = .data[["Y"]],
      label = .data[["Cohort"]]),
    size = 5.5
  ) +
  # 4. region label layer
  ggplot2::geom_label(
    data = demographic_venn_regionlabel_data,
    mapping = ggplot2::aes(
      x = .data[["X"]], y = .data[["Y"]],
      label = .data[["count"]]),
    size = 7,
    fill = "white"
  ) +
  ggplot2::scale_x_continuous(
    expand = ggplot2::expansion(mult = 0.2)
  ) +
  ggplot2::theme_void() +
  ggplot2::theme(
    text = ggplot2::element_text(size = 20)
  )

```

:::

::: {.column width="50%"}

```{r}
#| label: Venn Diagram Show
#| fig-height: 8
#| fig-align: center
#| fig-alt: |
#|   An venn diagram showing common variables within six cohorts

demographic_venn_diagram 

```

:::

::::

Venn diagram does not work for many (> 10) cohorts.

## Overview Diagrams

Upset plots are too complicated for clinicians.

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: Upset Diagram
#| echo: true
#| eval: true
#| output: false

demographic_venn <- tibble::tibble(
  column_name = c("Age", "Sex",
                  "Hypertension", "Dyslipidemia", "Family Hx CAD", "Diabetes",
                  "Smoke Current", "Smoke Past",
                  "Have Chest Pain", "Chest Pain Character",
                  "Dyspnea",
                  "BMI", "Height", "Weight",
                  "HDL", "Total Cholesterol", 
                  "Triglyceride", "LDL"),
  `Cohort A` = c(1, 1,
                 1, 1, 1, 1,
                 1, 1,
                 1, 1,
                 1,
                 1, 1, 1,
                 0, 0, 
                 0, 0),
  `Cohort B` = c(1, 1,
                 1, 1, 1, 1,
                 1, 1,
                 1, 1,
                 1,
                 0, 0, 0,
                 1, 1, 
                 1, 1),
  `Cohort C` = c(1, 1,
                 1, 1, 1, 1,
                 1, 1,
                 1, 1,
                 1,
                 1, 1, 1,
                 1, 1, 
                 1, 1),
  `Cohort D` = c(1, 1,
                 1, 1, 1, 1,
                 1, 1,
                 1, 1,
                 0,
                 1, 0, 0,
                 1, 1, 
                 1, 1),
  `Cohort E` = c(1, 1,
                 1, 1, 1, 1,
                 1, 1,
                 1, 1,
                 0,
                 1, 1, 1,
                 1, 1, 
                 0, 0),
  `Cohort F` = c(1, 1,
                 1, 1, 1, 1,
                 1, 1,
                 1, 1,
                 0,
                 1, 1, 1,
                 0, 0, 
                 0, 0),
)

cohort_a_upset_col_name <- "Cohort A\n(n=1000)"
cohort_b_upset_col_name <- "Cohort B\n(n=2000)"
cohort_c_upset_col_name <- "Cohort C\n(n=1500)"
cohort_d_upset_col_name <- "Cohort D\n(n=500)"
cohort_e_upset_col_name <- "Cohort E\n(n=1000)"
cohort_f_upset_col_name <- "Cohort F\n(n=2500)"


demographic_upset_data <- demographic_venn |>
  dplyr::rename(
    !!cohort_a_upset_col_name := "Cohort A",
    !!cohort_b_upset_col_name := "Cohort B",
    !!cohort_c_upset_col_name := "Cohort C",
    !!cohort_d_upset_col_name := "Cohort D",
    !!cohort_e_upset_col_name := "Cohort E",
    !!cohort_f_upset_col_name := "Cohort F"
  )

upset_plot <- ComplexUpset::upset(
  demographic_upset_data,
  c(cohort_a_upset_col_name, 
    cohort_b_upset_col_name, 
    cohort_c_upset_col_name,
    cohort_d_upset_col_name,
    cohort_e_upset_col_name,
    cohort_f_upset_col_name),
  base_annotations = list(
    `Intersection size` = 
      ComplexUpset::intersection_size(
        text = list(size = 9, nudge_y = 0.5),
        text_colors = c(on_background='black', 
                        on_bar='white')
      ) + 
      ggplot2::annotate(
        size = 5.5,
        geom = 'text', 
        x = Inf, 
        y = Inf,
        label = paste('Total:', nrow(demographic_venn)),
        vjust = 1, 
        hjust = 1
      ) + 
      ggplot2::theme(
        axis.title.y = ggplot2::element_text(angle = 0, size = 20),
        axis.title.x = ggplot2::element_text(angle = 0, size = 20), 
        text = ggplot2::element_text(size = 20)
      ) +
      ggplot2::labs(y = "",
                    title = "Intersection size")
      ),
  set_sizes = ( 
    ComplexUpset::upset_set_size() +
    ggplot2::geom_text(
      size = 5.5,
      mapping = ggplot2::aes(label= ggplot2::after_stat(.data[["count"]])), 
      hjust = 1.5, 
      stat = 'count') +
    ggplot2::expand_limits(y = 30) + 
    ggplot2::theme(
        axis.title.y = ggplot2::element_text(angle = 0, size = 15),
        axis.title.x = ggplot2::element_text(angle = 0, size = 15), 
        text = ggplot2::element_text(size = 15)
    ) +
    ggplot2::labs(y = "Number of variables")
  ),
  sort_intersections_by = "degree",
  sort_sets = FALSE,
  name = "", 
  width_ratio = 0.25,
  themes = ComplexUpset::upset_default_themes(
    text = ggplot2::element_text(size = 15)
    )
  )

```

:::

::: {.column width="50%"}

```{r}
#| label: Upset Diagram Print
#| fig-height: 8
#| fig-align: center
#| fig-alt: |
#|   An upset plot showing common variables within six cohorts

upset_plot |>
  print()
 
```

:::

Cannot answer follow-up questions:

[How many cohorts provide patient's blood lipid information and how many patients have them ?]{style="font-size: 80%;"}

::::

## Overview Diagrams

Create a "heatmap"using Microsoft PowerPoint.

![](images/suggested_heatmap.png){fig-alt="A modified heatmap to show command variables." fig-align="center" width="100%"}

## Summary

:::: {.columns}

::: {.column width="50%"}

![](images/data_harmonisation_smaller.png){fig-alt="The data harmonization process: Study data variables collected from different sources need to be mapped to one another, classified into the generalized concepts they represent, and transformed into unified harmonized variables for analysis" fig-align="center" width="100%" .fragment}

![](images/r_administration_summary.png){fig-alt="R Administration using pipes, namespacing, ,Renviron and .Rprofile file, R pacakges renv and pak and Posit Public Pacakge Manager." fig-align="center" width="100%" .fragment}


:::

::: {.column width="50%"}

![](images/project_organisation_summary.png){fig-alt="R project organisation using a research compendium, R packages here, fs, rcompendium and always starting the project in a blank slate." fig-align="center" width="100%" .fragment}

![](images/quarto_allison.png){fig-alt="Picture by Allison Horst about Quarto turning programming code to documents." fig-align="center" width="100%" .fragment}

:::

::::

## Summary

:::: {.columns}

::: {.column width="50%"}

![](images/variable_mapping_workflow.png){fig-alt="Variable Mapping Reporting Workflow. Starting with introducing the mapping procedure, writing code to do mapping ans validation, showing that the code works, clean up data for merging." fig-align="center" width="100%" .fragment}

![](images/daff_image_smaller.png){fig-alt="An interactive output showing the difference between two datasets from the R package daff." fig-align="center" width="100%" .fragment}

:::

::: {.column width="50%"}

![](images/documentation_types_for_harmonisation.png){fig-alt="Four major documentation type in terms of data harmonisation" fig-align="center" width="90%" .fragment}

![](images/suggested_heatmap.png){fig-alt="A modified heatmap to show command variables." fig-align="center" width="90%" .fragment}

:::

::::

## Thank you

:::: {.columns}

Harmonisation project template: <https://github.com/JauntyJJS/harmonisation/>{target="_blank"}

::: {.column width="50%"}

![](images/data_harmonisation_github_page.png){fig-alt="Data harmonisation project template on Github." fig-align="center" width="100%"}

:::

::: {.column width="50%"}

![](images/198-feature-complete.png){fig-alt="Comic from Monkeyuser.com showing a lot of work needs to be done after adding a new feature." fig-align="center" width="80%"}

[[Feature Complete](https://www.monkeyuser.com/2020/feature-complete/){target="_blank"} from [MonkeyUser.com](https://www.monkeyuser.com/){target="_blank"}]{style="font-size: 60%;"}

:::

::::
