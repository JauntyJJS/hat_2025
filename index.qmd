--- 
title: Retrospective clinical data harmonisation Reporting Using R and Quarto
author: Jeremy Selva [`r fontawesome::fa(name = "linkedin", fill = "#0077ac")`](https://www.linkedin.com/in/jeremy-selva-085b9112a/){target="_blank"} <br> @JauntyJJS [`r fontawesome::fa(name = "github", fill = "#000000")`](https://github.com/JauntyJJS){target="_blank"} [`r fontawesome::fa(name = "fab fa-square-x-twitter", fill = "#000000")`](https://twitter.com/JauntyJJS){target="_blank"} [`r fontawesome::fa(name = "bluesky", fill = "#1084ff")`](https://bsky.app/profile/jauntyjjs.bsky.social){target="_blank"} [<svg aria-hidden="true" role="img" viewBox="0 0 512 512" style="height:1em;width:1em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:#5f53e7;overflow:visible;position:relative;"><path d="M433 179.1c0-97.2-63.7-125.7-63.7-125.7-62.5-28.7-228.6-28.4-290.5 0 0 0-63.7 28.5-63.7 125.7 0 115.7-6.6 259.4 105.6 289.1 40.5 10.7 75.3 13 103.3 11.4 50.8-2.8 79.3-18.1 79.3-18.1l-1.7-36.9s-36.3 11.4-77.1 10.1c-40.4-1.4-83-4.4-89.6-54a102.5 102.5 0 0 1 -.9-13.9c85.6 20.9 158.7 9.1 178.8 6.7 56.1-6.7 105-41.3 111.2-72.9 9.8-49.8 9-121.5 9-121.5zm-75.1 125.2h-46.6v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.3V197c0-58.5-64-56.6-64-6.9v114.2H90.2c0-122.1-5.2-147.9 18.4-175 25.9-28.9 79.8-30.8 103.8 6.1l11.6 19.5 11.6-19.5c24.1-37.1 78.1-34.8 103.8-6.1 23.7 27.3 18.4 53 18.4 175z"/></svg>](https://fosstodon.org/@JauntyJJS){target="_blank"} <br> [*https://jeremy-selva.netlify.app* `r fontawesome::fa(name = "link", fill = "#666666")`](https://jeremy-selva.netlify.app/){target="_blank"} <br> For [HAT 2025 `r fontawesome::fa(name = "link", fill = "#666666")`](https://www.eventbrite.sg/o/cgh-harvest-analytics-together-hat-90682070963){target="_blank"}
date: 2025-11-14
date-format: "D[<sup style='font-size:65%;font-style:italic;'>th</sup>] MMMM YYYY"
lightbox: true
from: markdown+emoji
format:
  revealjs:
    theme: [custom.scss]
    mainfont: "Newsreader"
    code-line-numbers: true
    code-annotations: false
    code-overflow: scroll
    controls: true
    progress: true
    #slide-number: true # slide number determined be no_logo_at_title_slide.js
    scrollable: true
    transition: fade
    background-transition: fade
    highlight-style: arrow-dark
    # logo: images/qr.png
    include-after-body: no_logo_at_title_slide.js

--- 

```{r}
#| label: for presentation
#| include: false

library(fontawesome)
library(knitr)
library(yaml)
library(rmarkdown)
library(here)

out_type <- knitr::opts_chunk$get("rmarkdown.pandoc.to")
```

## whoami

Research Officer from [National Heart Centre Singapore](https://www.nhcs.com.sg/){target="_blank"} who collects, cleans and harmonises clinical data.

![](images/allison_horst2.png){fig-alt="Picture by Allison Horst about a data analyst facing a dataset in the form of a monster." fig-align="center" width="70%"}

[Taming the Data Beast from ["Cleaning Medical Data with R"](https://www.pipinghotdata.com/workshops/2023-06-06-cleaning-medical-data-with-r/){target="_blank"} workshop by Shannon Pileggi, Crystal Lewis and Peter Higgins presented at R/Medicine 2023. Illustrated by [Allison Horst](https://allisonhorst.com/){target="_blank"}]{style="font-size: 60%;"}.

## About Data Harmonisation

Data harmonisation is part of data wrangling process where

-  Similar variables from different datasets are identified.
-  Grouped based on a generalised concept they represent.
-  Transformed into unified harmonised variables for analysis.

![](images/data_harmonisation.png){fig-alt="The data harmonization process: Study data variables collected from different sources need to be mapped to one another, classified into the generalized concepts they represent, and transformed into unified harmonized variables for analysis" fig-align="center" width="90%"}

[Image from Mallya et al. Circ Cardiovasc Qual Outcomes. 2023 Nov; 16(11):e009938 doi: [10.1161/CIRCOUTCOMES.123.009938](https://doi.org/10.1161/CIRCOUTCOMES.123.009938){target="_blank"}]{style="font-size: 60%;"}.

## How it started

![](images/welcome.png){fig-alt="Figure showing me welcoming the collaborator to the project and sending them a data dictionary and template file for them to use and send the data back to me." fig-align="center" width="90%"}

[[Cheerful Businessman](https://www.vecteezy.com/png/57446607-a-cheerful-little-businessman-carrying-a-briefcase-walks-confidently-on-a-bright-day-in-a-fun-animated-style-little-business-man-illustrationisolated-on-transparent-background){target="_blank"} designed by [Iftikhar Alam](https://www.vecteezy.com/members/iftikharalam){target="_blank"} from [Vecteezy](http://www.vecteezy.com){target="_blank"} and [Medical Doctor Man](https://creazilla.com/media/clipart/33960/trevor-medical-doctor-man){target="_blank"} from [Creazilla](https://creazilla.com/){target="_blank"}]{style="font-size: 60%;"}.

## How it started

![](images/collaborator_issue.png){fig-alt="Figure showing the collaborator sharing that he does not have an analyst to do the mapping and warns that if his end were to do it himself, it will take a long time." fig-align="center" width="90%"}

[[Cheerful Businessman](https://www.vecteezy.com/png/57446607-a-cheerful-little-businessman-carrying-a-briefcase-walks-confidently-on-a-bright-day-in-a-fun-animated-style-little-business-man-illustrationisolated-on-transparent-background){target="_blank"} designed by [Iftikhar Alam](https://www.vecteezy.com/members/iftikharalam){target="_blank"} from [Vecteezy](http://www.vecteezy.com){target="_blank"} and [Medical Doctor Man](https://creazilla.com/media/clipart/33960/trevor-medical-doctor-man){target="_blank"} from [Creazilla](https://creazilla.com/){target="_blank"}]{style="font-size: 60%;"}.

## How it started

![](images/collaborator_request_1.png){fig-alt="Figure showing the collaborator saying that they will send the data to me and ask me to do the data harmonisation instead." fig-align="center" width="90%"}

[[Cheerful Businessman](https://www.vecteezy.com/png/57446607-a-cheerful-little-businessman-carrying-a-briefcase-walks-confidently-on-a-bright-day-in-a-fun-animated-style-little-business-man-illustrationisolated-on-transparent-background){target="_blank"} designed by [Iftikhar Alam](https://www.vecteezy.com/members/iftikharalam){target="_blank"} from [Vecteezy](http://www.vecteezy.com){target="_blank"} and [Medical Doctor Man](https://creazilla.com/media/clipart/33960/trevor-medical-doctor-man){target="_blank"} from [Creazilla](https://creazilla.com/){target="_blank"}]{style="font-size: 60%;"}.

## How it started

![](images/qa_image_monkeyuser.png){fig-alt="Figure showing a sad guy receving a package/data full of bugs and issue." fig-align="center" width="90%"}

[[snapshot from Ready for QA | MonkeyUser 2SP Animation Video](https://www.youtube.com/watch?v=5Z8HDADU57U&ab_channel=MonkeyUser){target="_blank"} from [MonkeyUser.com](https://www.monkeyuser.com/)]{style="font-size: 60%;"}.

## How it started

![](images/qa_image_monkeyuser_9_times.png){fig-alt="A 3 by 3 repeared figure showing a sad guy receving a package/data full of bugs and issue." fig-align="center" width="90%"}

[[snapshot from Ready for QA | MonkeyUser 2SP Animation Video](https://www.youtube.com/watch?v=5Z8HDADU57U&ab_channel=MonkeyUser){target="_blank"} from [MonkeyUser.com](https://www.monkeyuser.com/)]{style="font-size: 60%;"}.

## How it started

Turn my sorrow into opportunities.

```{=html}
<iframe width="990" height="560" src="https://jauntyjjs.github.io/useR-2024/#/title-slide" frameborder="0" allowfullscreen></iframe>
```

## Why a harmonisation report

![](images/collaborator_request_2.png){fig-alt="Figure showing the collaborator saying that they need the harmonised dataset back with a report for higher management to show to data auditors." fig-align="center" width="90%"}

[[Cheerful Businessman](https://www.vecteezy.com/png/57446607-a-cheerful-little-businessman-carrying-a-briefcase-walks-confidently-on-a-bright-day-in-a-fun-animated-style-little-business-man-illustrationisolated-on-transparent-background){target="_blank"} designed by [Iftikhar Alam](https://www.vecteezy.com/members/iftikharalam){target="_blank"} from [Vecteezy](http://www.vecteezy.com){target="_blank"} and [Medical Doctor Man](https://creazilla.com/media/clipart/33960/trevor-medical-doctor-man){target="_blank"} from [Creazilla](https://creazilla.com/){target="_blank"}]{style="font-size: 60%;"}.

## Why a harmonisation report

Some data fields just cannot be planned in advanced.

![](images/ethnicity_table.png){fig-alt="Figure showing different race or ethnicity grouping from different collaborators that it is impossible to plan race or ethnicity grouping." fig-align="center" width="90%"}

## Issues

:::: {.columns}

::: {.column width="50%"}

While there are {{< fa brands r-project >}} ðŸ“¦ to facilitate data harmonisation,

*  [`retroharmonize`](https://github.com/rOpenGov/retroharmonize/){target="_blank"} for survey data.

*  [`Rmonize`](https://maelstrom-research.github.io/Rmonize-documentation/index.html){target="_blank"} for epidemiological data.

*  [`psHarmonize`](https://github.com/NUDACC/psHarmonize){target="_blank"} for health and education data.

There are limited resources on how to make a data harmonisation report.

:::

::: {.column width="50%"}

![](images/210-denvercoder9.png){fig-alt="Comic from Monkeyuser.com showing that it is hard to get help with programming issues." fig-align="center" width="100%"}

[[Denvercoder9](https://www.monkeyuser.com/2021/denvercoder9/){target="_blank"} from [MonkeyUser.com](https://www.monkeyuser.com/){target="_blank"}]{style="font-size: 60%;"}

:::

::::

## Harmonisation Project Template

A template to offer a systematic way to report data harmonisation processes. 

[Link: <https://jauntyjjs.github.io/harmonisation/>]

```{=html}
<iframe width="1000" height="500" src="https://jauntyjjs.github.io/harmonisation/" title="Harmonisation template" ></iframe>
```


## Tools to create documentation

![](images/r_and_quarto.png){fig-alt="Figure showing the logo of the R programming language and hexsticker of Quarto." fig-align="center" width="80%"}

[[R Programming Logo](https://www.cleanpng.com/png-scalable-vector-graphics-cran-statgraphics-rnn-vit-6890332/download-png.html){target="_blank"} from [CleanPNG](https://www.cleanpng.com/){target="_blank"} and [Quarto Hex Sticker](https://rstudio.github.io/cheatsheets/html/quarto.html){target="_blank"} from [Posit](https://posit.co/){target="_blank"}]{style="font-size: 60%;"}.

## 

<br>

::: {.center-x .r-fit-text}
What [*Did*]{.important} We Forget <br> to Teach You about {{< fa brands r-project >}} ?
:::

![](images/what_is_R_programming.png){fig-alt="Figure showing a Google search on what is the R Programming Language." fig-align="center" width="80%"}

##

![](images/everything-else.png){fig-alt="Figure showing that R is taught only as a tool to do statistics but not other stuffs." fig-align="center" width="80%"}

[Image from [Project Oriented Workflows slides](https://rstats-wtf.github.io/wtf-project-oriented-workflow-slides/#/title-slide){target="_blank"} from [What They Forgot to Teach You About R](http://rstats.wtf)]{style="font-size: 60%;"}.

<br>

We will share a glimpse of "Everything else" R and its friends can do.

## Project Organisation

[*Organise*]{.important} your project as you go instead of waiting for "tomorrow". 

Data is cheap but time is expensive.

:::: {.columns}

::: {.column width="50%"}

![](images/research_compendium.svg){fig-alt="Figure showing Research Compendium as a tool to sort out different analysis." fig-align="center" width="80%"}

:::

::: {.column width="50%"}

![](images/project_layout.png){fig-alt="Comic from Monkeyuser.com showing that it is hard to get help with programming issues." fig-align="center" width="80%"}

:::

::::

[[Research Compendium](https://book.the-turing-way.org/reproducible-research/compendia/){target="_blank"} by Scriberia from [The Turing Way project](https://book.the-turing-way.org/){target="_blank"} and Project Layout from [Good enough practices in scientific computing](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1005510){target="_blank"}]{style="font-size: 60%;"}.

## Project Organisation

My harmoniation template organisation is based on the {{< fa brands r-project >}} ðŸ“¦ [`rcompendium`](https://frbcesab.github.io/rcompendium/){target="_blank"} but there are others as well.

```{r}
#| label: hexsession

hexsession::make_tile(
  local_images = c(
    here::here("images", "hex_rcompendium.png"),
    here::here("images", "hex_workflowr.png"),
    here::here("images", "hex_orderly.png")
  ),
  local_urls = c(
    "https://frbcesab.github.io/rcompendium/",
    "https://workflowr.github.io/workflowr/",
    "https://mrc-ide.github.io/orderly/"
  )
)

```

<!-- ```{=html}
<iframe width="800" height="200" src="./temp_hexsession/_hexout.html" title="Webpage example"></iframe>
``` -->

## {{< fa brands r-project >}} Session

Before {{< fa brands r-project >}} starts up in a given project, it will perform the following steps

1. Set up Environment Variables.
2. Run startup script.
3. Set up the {{< fa brands r-project >}} session.

We can customise Step 1 and 2 using these two main text files.

-  `.Renviron` (Contains environment variables to be set in {{< fa brands r-project >}} sessions.)
-  `.Rprofile` (Contains {{< fa brands r-project >}} code to be run in each session.)

![](images/start_up_enviromental_files.png){fig-alt="Figure showing the .Renviron and .Rprofile file in an R project template." fig-align="center" width="60%"}

## what goes in `.Renviron`

:white_check_mark: {{< fa brands r-project >}}-specific [environment variables](https://cran.r-project.org/doc/manuals/r-devel/R-ints.html){target="_blank"}.\
:white_check_mark: API keys or other secrets\
:x: R code

``` bash
APPDATA="D:/Jeremy/PortableR/RAppData/Roaming"
LOCALAPPDATA="D:/Jeremy/PortableR/RAppData/Local"
TEMP="D:/Jeremy/PortableR/RPortableWorkDirectory/temp"
TMP="D:/Jeremy/PortableR/RPortableWorkDirectory/temp"
_R_CHECK_SYSTEM_CLOCK_=0
RENV_CONFIG_PAK_ENABLED=TRUE
CONNECT_API_KEY=DaYK2hBUriSBYUEGIAiyXsRJHSjTYJN3
DB_USER=elephant
DB_PASS=p0stgr3s
```
::: columns
::: {.column width="40%"}
### user

`~/.Renviron`
:::

::: {.column width="60%"}
### project

`path/to/your/project/.Renviron`
:::
:::

::: aside
Adapted from [Personal R Administration](https://rstats-wtf.github.io/wtf-personal-radmin-slides/#/how-do-i-know-i-got-a-binary){target="_blank"}
:::

## what goes in `.Rprofile`

:white_check_mark: set a default CRAN mirror.\
:white_check_mark: customize [R prompt](https://github.com/gaborcsardi/prompt/){target="_blank"}.\

```r
source("renv/activate.R")
options(
  repos = c(
    P3M_20250306 = "https://packagemanager.posit.co/cran/2025-10-13",
    ropensci = "https://ropensci.r-universe.dev",
    janmarvin = "https://janmarvin.r-universe.dev",
    CRAN = 'https://cloud.r-project.org'
  )
)
if (interactive()) prompt::set_prompt(prompt::prompt_fancy)
```

Examples: <https://github.com/search?q=.Rprofile&type=repositories>{target="_blank"}

{{< fa brands github >}} [csgillespie/rprofile](https://github.com/csgillespie/rprofile){target="_blank"}.\
{{< fa brands youtube >}} [Me, Myself and my Rprofile](https://www.youtube.com/watch?v=2rWi2KVcyjg){target="_blank"}.\
{{< fa blog >}} [Customising your Rprofile](https://www.jumpingrivers.com/blog/customising-your-rprofile/){target="_blank"}.

::: aside
Adapted from [Personal R Administration](https://rstats-wtf.github.io/wtf-personal-radmin-slides/#/how-do-i-know-i-got-a-binary){target="_blank"}
:::

## States of {{< fa brands r-project >}} ðŸ“¦

{{< fa brands r-project >}} ðŸ“¦ -- [Structure](https://r-pkgs.org/Structure.html){target="_blank"}

```{mermaid}
flowchart TD
subgraph dev
direction LR
Source -- "devtools::build()" --> Bundled
Bundled -- "devtools::build(binary=TRUE)" --> Binary
end
style Source fill: lightgray
style Bundled fill: lightgray
style Binary fill: lightgray
style dev fill: lightyellow
```

```{mermaid}
flowchart TD
subgraph use
direction LR
Binary --"install.packages()
pak::pak()
renv::install()"--> Installed
Installed --"library()"--> Loaded
end
style Binary fill: lightgray
style Installed fill: lightgray
style Loaded fill: lightgray
style use fill: lightyellow
```

::: aside
Adapted from [Personal R Administration](https://rstats-wtf.github.io/wtf-personal-radmin-slides/#/how-do-i-know-i-got-a-binary){target="_blank"}
:::

## Binary {{< fa brands r-project >}} ðŸ“¦ Installation

Go for ({{< fa brands windows >}} | {{< fa brands apple >}}) binary {{< fa brands r-project >}} ðŸ“¦ in CRAN.

-   compiled ahead of time -> easiest / fastest to install

![](images/binary_in_cran.png){fig-alt="Figure showing the Windows and Mac binary files of R package pretestcad." fig-align="center" width="80%"}

## R-universe and Posit Public Package Manager

::: columns

::: {.column width="40%"}

Consider installing ({{< fa brands windows >}} | {{< fa brands apple >}} | {{< fa brands linux >}} ) binaries from 

-  [R-universe](https://r-universe.dev/search){target="_blank"} 
-  [Posit Public Package Manager](https://p3m.dev/client/#/){target="_blank"}.

Set in your `.Rprofile` file.

```{.r code-line-numbers="3-4"}
options(
  repos = c(
    P3M_20250306 = "https://packagemanager.posit.co/cran/2025-10-13",
    ropensci = "https://ropensci.r-universe.dev",
    CRAN = 'https://cloud.r-project.org'
  )
)
```

:::

::: {.column width="60%"}

![](images/appsilon_R_universe.png){fig-alt="Website of Appsilon R-universe." fig-align="center" width="90%"}

![](images/posit_public_package_manager.png){fig-alt="Website of Posit Public Package Manager." fig-align="center" width="90%"}

:::

:::

## How do I know I got a binary?

::: panel-tabset

### CRAN {{< fa brands windows >}}

``` {.r code-line-numbers="4,10"}
> install.packages("parallelly", repos = "https://cran.r-project.org")
Installing package into â€˜C:/Users/edavi/Documents/R/win-library/4.1â€™
(as â€˜libâ€™ is unspecified)
trying URL 'https://cran.r-project.org/bin/windows/contrib/4.1/parallelly_1.32.1.zip'
Content type 'application/zip' length 306137 bytes (298 KB)
downloaded 298 KB

package â€˜parallellyâ€™ successfully unpacked and MD5 sums checked

The downloaded binary packages are in
    C:\Users\edavi\AppData\Local\Temp\Rtmpa2s3e8\downloaded_packages
```

### CRAN {{< fa brands apple >}}

``` {.r code-line-numbers="4,10"}
> install.packages("renv", repos="https://cran.r-project.org")
Installing package into â€˜/Users/edavidaja/Library/R/x86_64/4.1/libraryâ€™
(as â€˜libâ€™ is unspecified)
trying URL 'https://cran.r-project.org/bin/macosx/contrib/4.1/renv_0.15.5.tgz'
Content type 'application/x-gzip' length 1866760 bytes (1.8 MB)
==================================================
downloaded 1.8 MB


The downloaded binary packages are in
 /var/folders/b5/fl4ff68d23s148tg1_1gnflc0000gn/T//RtmpMk69B0/downloaded_packages
```

### p3m

``` {.r code-line-numbers="4,10"}
> install.packages("remotes")
Installing package into â€˜C:/Users/WDAGUtilityAccount/AppData/Local/R/win-library/4.2â€™
(as â€˜libâ€™ is unspecified)
trying URL 'https://p3m.dev/cran/latest/bin/windows/contrib/4.2/remotes_2.4.2.zip'
Content type 'binary/octet-stream' length 399930 bytes (390 KB)
downloaded 390 KB

package â€˜remotesâ€™ successfully unpacked and MD5 sums checked

The downloaded binary packages are in
  C:\Users\WDAGUtilityAccount\AppData\Local\Temp\RtmpA1edRi\downloaded_packages
```

:::

::: aside
Adapted from [Personal R Administration](https://rstats-wtf.github.io/wtf-personal-radmin-slides/#/how-do-i-know-i-got-a-binary){target="_blank"}
:::

## Source {{< fa brands r-project >}} ðŸ“¦ Installation

Go for source {{< fa brands r-project >}} ðŸ“¦ if you need the latest version urgently.

![](images/binary_not_latest.png){fig-alt="Figure showing the Windows binary files are not the latest version for R package parallelly." fig-align="center" width="70%"}

 {{< fa brands linux >}} only have source {{< fa brands r-project >}} ðŸ“¦ in CRAN.

## Source {{< fa brands r-project >}} ðŸ“¦ Installation

You will need additional tools and dependencies. 

::: panel-tabset

### windows {{< fa brands windows >}}

Install [Rtools](https://cran.r-project.org/bin/windows/Rtools/){target="_blank"}

### macOS {{< fa brands apple >}}

Install [XCode](https://apps.apple.com/us/app/xcode/id497799835?mt=12){target="_blank"} :warning: take some time to install

``` {.bash code-line-numbers="false"}
xcode-select --install
```

### linux {{< fa brands linux >}}

install tools via package manager, e.g.

``` bash
apt install make
```

:::

<br>

Run `devtools::has_devel()` in console.

> `## Your system is ready to build packages!`

::: aside
Adapted from [Personal R Administration](https://rstats-wtf.github.io/wtf-personal-radmin-slides/#/how-do-i-know-i-got-a-binary){target="_blank"}
:::

## Install using {{< fa brands r-project >}} ðŸ“¦ [`pak`](https://pak.r-lib.org/index.html){target="_blank"}

Consider using [`pak::pkg_install`](https://pak.r-lib.org/reference/pkg_install.html){target="_blank"} instead of `install.packages()`

```{=html}
<iframe width="1000" height="500" src="https://r-in-production.org/packages.html" title="R in Production Chapter 6 Package installation" ></iframe>
```

## Isolated project environment using [`renv`](https://rstudio.github.io/renv/index.html){target="_blank"}

Most commonly used {{< fa brands r-project >}} ðŸ“¦ to create isolated project environments.

-  {{< fa brands youtube >}} [You should be using renv](https://www.youtube.com/watch?v=GwVx_pf2uz4){target="_blank"}.\
-  {{< fa file-powerpoint >}} [Making your R project future-proof with renv](https://ecohealthalliance.github.io/targets-renv-example/outputs/renv-presentation){target="_blank"}.\

```{=html}
<iframe width="800" height="400" src="https://rstudio.github.io/renv/articles/lockfile.html" title="Anatomy of a Lockfile" ></iframe>
```

## {{< fa brands r-project >}} "virtual environment" using [`renv`](https://rstudio.github.io/renv/index.html){target="_blank"}

Some advice ...

-  Set `RENV_CONFIG_PAK_ENABLED=TRUE` in the `.Renviron` file for `renv::install()` uses `pak` at the backend to install {{< fa brands r-project >}} ðŸ“¦.
-  In an existing project, use `renv::init(bare = TRUE)` to initiate renv with an empty {{< fa brands r-project >}} library and then install {{< fa brands r-project >}} ðŸ“¦ manaully.
-  Indicate folders/files in the `.renvignore` file to ignore to speed up the snapshot process (`renv::snapshot`)
-  You can update the repositories specified in the `renv.lock` file.
   -  {{< fa blog >}} [Shannon Pileggi's blog on `renv::restore()`](https://www.pipinghotdata.com/posts/2024-09-16-ease-renvrestore-by-updating-your-repositories-to-p3m/){target="_blank"}.

## New Kid for {{< fa brands r-project >}} ðŸ“¦ managment [`Require`](https://require.predictiveecology.org/){target="_blank"}

```{=html}
<iframe width="1000" height="500" src="https://require.predictiveecology.org/" title="Homepage of R pacakage Require" ></iframe>
```

## Quarto

[Quarto](https://quarto.org/){target="_blank"} is an open-source software that weaves narrative and programming code together to produce elegantly formatted output as documents (in HTML, Word, PDF), presentations, books, web pages, and more.

![](images/quarto_allison.png){fig-alt="Picture by Allison Horst about Quarto turning programming code to documents." fig-align="center"}
[[Artwork](https://allisonhorst.com/cetinkaya-rundel-lowndes-quarto-keynote){target="_blank"} from ["Hello, Quarto"](https://www.youtube.com/watch?v=p7Hxu4coDl8) keynote by Julia Lowndes and Mine Ã‡etinkaya-Rundel, presented at RStudio Conference 2022. Illustrated by [Allison Horst](https://allisonhorst.com/){target="_blank"}]{style="font-size: 80%;"}.

## Open A Quarto Document

Create a Quarto document

![](images/create_a_quarto_doc_grouped.png){fig-alt="Steps to create a Quarto document" fig-align="center"}

## Render to HTML Report

![](images/quarto_render.png){fig-alt="Steps to render a Quarto document to a report in html" fig-align="center"}

## Quarto Level 1

A Quarto file is a plain text file that has the extension `.qmd` containing three important types of content:

![](images/quarto_format.png){fig-alt="Quarto file has three contents: An optional YAML header surrounded by `---`s, Chunks of R code surrounded by ```s and Text mixed with markdown text formatting." fig-align="center"}
[Simple Quarto file example from [R for Data Science (2e) Chapter 28 Quarto](https://r4ds.hadley.nz/quarto.html#quarto-basics)]{style="font-size: 80%;"}

## Quarto Level 1

<https://kpuka.ca/resources/quarto_intro.html>{target="_blank"}

```{=html}
<iframe width="1000" height="550" src="https://kpuka.ca/resources/quarto_intro.html" title="Introduction to Quarto by Klajdi Puka, PhD" ></iframe>
```

## Quarto Books/Websites

```{=html}
<iframe width="1000" height="550" src="https://jauntyjjs-harmonisation-cohort-b.netlify.app/" title="Cohort_B Harmonisation Report in html" ></iframe>
```

## Quarto Level 2

To make a Quarto book or website, we need a `_quarto.yml` and `index.qmd` file

:::: {.columns}

::: {.column width="50%"}

![](images/quarto_yml.png){fig-alt="A preview of the _quarto.yml file." fig-align="center" width="100%"}

:::

::: {.column width="50%"}

![](images/index_qmd.png){fig-alt="A preview of the index.qmd file." fig-align="center" width="100%"}

:::

::::

## Quarto Level 2

`_quarto.yml` is a [configuration file](https://quarto.org/docs/projects/quarto-projects.html){target="_blank"} to tell Quarto to create a book.

````{.yaml filename="_quarto.yml"}
---
project:
  type: book
  output-dir: reports/Cohort_B

book:
  downloads: [pdf, docx]
  title: "Harmonisation Template for Cohort B"
  author: "My Name"
  navbar:
    search: true
  sidebar:
    collapse-level: 1

  chapters:
    - index.qmd
    - part: Cohort B Cleaning
      chapters:
        - codes/Cohort_B/00_R_Package_And_Environment.qmd
        - codes/Cohort_B/01_Read_Cohort_B_Data.qmd
        - codes/Cohort_B/02_Extract_Demographic.qmd
        - codes/Cohort_B/03_Export_To_Excel.qmd

crossref:
  chapters: false
  fig-title: Figure     # (default is "Figure")
  tbl-title: Table      # (default is "Table")
  fig-prefix: Figure    # (default is "Figure")
  tbl-prefix: Table     # (default is "Table")
  ref-hyperlink: true   # (default is true)
  title-delim: ":"      # (default is ":")

bibliography: references.bib
csl: csl_file.csl

format:
  html:
    toc: true
    toc-depth: 5
    toc-location: right
    toc-expand: true
    number-sections: true
    number-depth: 5
    smooth-scroll: true
    theme:
      light:
        - flatly
        #- custom.scss
      dark:
        - solar
  docx:
    reference-doc: custom-reference.docx
    toc: true
    toc-depth: 5
    number-sections: true
    number-depth: 5
    prefer-html: true
    highlight-style: github
  pdf:
    pdf-engine: xelatex
    documentclass: scrreprt
    papersize: a4
    toc-depth: 5
    number-sections: true
    number-depth: 5
    keep-tex: false
    include-in-header:
      text: |
        \usepackage{fvextra}
        \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
        \DefineVerbatimEnvironment{OutputCode}{Verbatim}{breaklines,commandchars=\\\{\}}
    include-before-body:
      text: |
        \begin{flushleft}
        \begin{sloppypar}
        \RecustomVerbatimEnvironment{verbatim}{Verbatim}{
          showspaces = false,
          showtabs = false,
          breaksymbolleft={}, % Need pacakge fvextra
          breaklines
          % Note: setting commandchars=\\\{\} here will cause an error
        }
    include-after-body:
      text: |
        \end{sloppypar}
        \end{flushleft}
---
````

## Quarto Level 2

`index.qmd` file gives the preface (homepage) content of the Quarto book (website). It is [compulsory](https://quarto.org/docs/books/book-structure.html){target="_blank"} file needed for the rendering to work.

````{.r filename="index.qmd"}
---
date: "2025-03-10"
format:
  html:
    code-fold: true
    freeze: false
params:
  show_table: TRUE
---

```{{r}}
#| label: output type
#| echo: false
#| warning: false
#| message: false

out_type <- knitr::opts_chunk$get("rmarkdown.pandoc.to")
```

# Preface {.unnumbered .unlisted}

Here is the documentation of the data harmonisation step generated using [Quarto](https://quarto.org/). To learn more about Quarto books visit <https://quarto.org/docs/books>.

## File Structure

Here is the file structure of the project used to generate the document.

```
harmonisation/                            # Root of the project template.
|
â”œâ”€â”€ .quarto/ (not in repository)          # Folder to keep intermediate files/folders 
|                                         # generated when Quarto renders the files.
|
â”œâ”€â”€ archive/                              # Folder to keep previous books and harmonised data.
|   |
â”‚   â”œâ”€â”€ reports/                          # Folder to keep previous versions of
|   |   |                                 # data harmonisation documentation.
|   |   |
|   |   â”œâ”€â”€ {some_date}_batch/            # Folder to keep {some_date} version of
|   |   |                                 # data harmonisation documentation.
|   |   |
|   |   â””â”€â”€ Flowchart.xlsx                # Flowchart sheet to record version control.
|   |
|   â””â”€â”€ harmonised/                       # Folder to keep previous version of harmonised data.
|       |
|       â”œâ”€â”€ {some_date}_batch/            # Folder to keep {some_date} version of
|       |                                 # harmonised data.
|       |
|       â””â”€â”€ Flowchart.xlsx                # Flowchart sheet to record version control.
|
â”œâ”€â”€ codes/                                # Folder to keep R/Quarto scripts 
|   |                                     # to run data harmonisation.
|   |
â”‚   â”œâ”€â”€ {cohort name}/                    # Folder to keep Quarto scripts to run
|   |   |                                 # data cleaning, harmonisation 
|   |   |                                 # and output them for each cohort.
|   |   |
|   |   â””â”€â”€ preprocessed_data/            # Folder to keep preprocessed data.
|   |
â”‚   â”œâ”€â”€ harmonisation_summary/            # Folder to keep Quarto scripts to create
|   |                                     # data harmonisation summary report.
|   |
â”‚   â”œâ”€â”€ output/                           # Folder to keep harmonised data.
|   |                                     
|   â”œâ”€â”€ cohort_harmonisation_script.R     # R script to render each {cohort name}/ folder. 
|   |                                     # folder into html, pdf and word document.
|   |
|   â””â”€â”€ harmonisation_summary_script.R    # R script to render the {harmonisation_summary}/ 
|                                         # folder into word document.
â”‚  
â”œâ”€â”€ data-raw/                             # Folder to keep cohort raw data (.csv, .xlsx, etc.)
|   |
â”‚   â”œâ”€â”€ {cohort name}/                    # Folder to keep cohort raw data.
|   |   |
|   |   â”œâ”€â”€ {data_dictionary}             # Data dictionary file that correspond to the 
|   |   |                                 # cohort raw data. Can be one from the
|   |   |                                 # collaborator provide or provided by us.
|   |   |
|   |   â””â”€â”€ Flowchart.xlsx                # Flowchart sheet to record version control.
|   |
|   â”œâ”€â”€ data-dictionary/                  # Folder to keep data dictionary 
|   |   |                                 # used for harmonising data.
|   |   |
|   |   â””â”€â”€ Flowchart.xlsx                # Flowchart sheet to record version control.
|   |
|   â””â”€â”€ data-input/                       # Folder to keep data input file 
|       |                                 # for collaborators to fill in.
|       |
|       â””â”€â”€ Flowchart.xlsx                # Flowchart sheet to record version control.
|  
â”œâ”€â”€ docs/                                 # Folder to keep R functions documentation 
|                                         # generated using pkgdown:::build_site_external().
|  
â”œâ”€â”€ inst/                                 # Folder to keep arbitrary additional files 
|   |                                     # to include in the project.
|   |  
|   â””â”€â”€ WORDLIST                          # File generated by spelling::update_wordlist()
|  
â”œâ”€â”€ man/                                  # Folder to keep R functions documentation
|   |                                     # generated using devtools::document().
|   |
â”‚   â”œâ”€â”€ {fun-demo}.Rd                     # Documentation of the demo R function.
|   |
â”‚   â””â”€â”€ harmonisation-template.Rd         # High-level documentation.
|  
â”œâ”€â”€ R/                                    # Folder to keep R functions.
|   |
â”‚   â”œâ”€â”€ {fun-demo}.R                      # Script with R functions.
|   |
â”‚   â””â”€â”€ harmonisation-package.R           # Dummy R file for high-level documentation.
â”‚  
â”œâ”€â”€ renv/ (not in repository)             # Folder to keep all packages 
|                                         # installed in the renv environment.
| 
â”œâ”€â”€ reports/                              # Folder to keep the most recent data harmonisation
|                                         # documentation.
|
â”œâ”€â”€ templates/                            # Folder to keep template files needed to generate
|   |                                     # data harmonisation documentation efficiently.
|   |
|   â”œâ”€â”€ quarto-yaml/                      # Folder to keep template files to generate 
|   |   |                                 # data harmonisation documentation structure 
|   |   |                                 # in Quarto. 
|   |   |
â”‚   |   â”œâ”€â”€ _quarto_{cohort name}.yml     # Quarto book template data harmonisation documentation 
|   |   |                                 # for {cohort name}.
|   |   |
|   |   â””â”€â”€ _quarto_summary.yml           # Quarto book template data harmonisation summary.
|   |
|   â””â”€â”€ index-qmd/                        # Folder to keep template files to generate
|       |                                 # the preface page of the data harmonisation 
|       |                                 # documentation.
|       |
|       â”œâ”€â”€ _index_report.qmd             # Preface template for each cohort data harmonisation
|       |                                 # report. 
|       |
|       â””â”€â”€ _index_summary.qmd            # Preface template for data harmonisation 
|                                         # summary report. 
|        
â”œâ”€â”€ tests/                                # Folder to keep test unit files. 
|                                         # Files will be used by R package testhat.
|
â”œâ”€â”€ .Rbuildignore                         # List of files/folders to be ignored while 
â”‚                                         # checking/installing the package.
|
â”œâ”€â”€ .Renviron (not in repository)         # File to set environment variables.
|
â”œâ”€â”€ .Rprofile (not in repository)         # R code to be run when R starts up.
|                                         # It is run after the .Renviron file is sourced.
|
â”œâ”€â”€ .Rhistory (not in repository)         # File containing R command history.
|
â”œâ”€â”€ .gitignore                            # List of files/folders to be ignored while 
â”‚                                         # using the git workflow.
|
â”œâ”€â”€ .lintr                                # Configuration for linting
|                                         # R projects and packages using linter.
|        
â”œâ”€â”€ .renvignore                           # List of files/folders to be ignored when 
â”‚                                         # renv is doing its snapshot.
|
â”œâ”€â”€ DESCRIPTION[*]                        # Overall metadata of the project.
|
â”œâ”€â”€ LICENSE                               # Content of the MIT license generated via
|                                         # usethis::use_mit_license().
|
â”œâ”€â”€ LICENSE.md                            # Content of the MIT license generated via
|                                         # usethis::use_mit_license().
|
â”œâ”€â”€ NAMESPACE                             # List of functions users can use or imported
|                                         # from other R packages. It is generated 
|                                         # by devtools::document().
â”‚        
â”œâ”€â”€ README.md                             # GitHub README markdown file generated by Quarto.
|
â”œâ”€â”€ README.qmd                            # GitHub README quarto file used to generate README.md. 
|        
â”œâ”€â”€ _pkgdown.yml                          # Configuration for R package documentation
|                                         # using pkgdown:::build_site_external().
|        
â”œâ”€â”€ _quarto.yml                           # Configuration for Quarto book generation.
|                                         # It is also the project configuration file.
|
â”œâ”€â”€ csl_file.csl                          # Citation Style Language (CSL) file to ensure
|                                         # citations follows the Lancet journal.
|        
â”œâ”€â”€ custom-reference.docx                 # Microsoft word template for data harmonisation 
|                                         # documentation to Word.
|
â”œâ”€â”€ harmonisation_template.Rproj          # RStudio project file.
|        
â”œâ”€â”€ index.qmd                             # Preface page of Quarto book content.
|        
â”œâ”€â”€ references.bib                        # Bibtex file for Quarto book.
|      
â””â”€â”€ renv.lock                             # Metadata of R packages installed generated
                                          # using renv::snapshot().

[*] These files are automatically created but user needs to manually add some information.
```
````

## Quarto (Reference)

<https://quarto.org/>{target="_blank"}

```{=html}
<iframe width="1000" height="550" src="https://quarto.org/" title="Quarto Homepage" ></iframe>
```

## Workflow with collaborators

Collaborator can send the raw data once and you keep updating the cleaned data for harmonsation.

![](images/collaborator_no_change_raw_data_workflow.png){fig-alt="Picture showing a top workfow to first clean data for harmonisation before doing the actual harmonisation. Bottom workflow to verfiy with the collaborators and update the clean data for harmonisation periodically" fig-align="center" width="80%"}

[[Dataset vectors](https://www.vecteezy.com/vector-art/25844300-abstract-database-info-silhouette-illustration){target="_blank"} by [Vectora Artworks](https://www.vecteezy.com/members/vectoroartworks){target="_blank"} from [Vecteezy](https://www.vecteezy.com/){target="_blank"}.]{style="font-size: 60%;"}
